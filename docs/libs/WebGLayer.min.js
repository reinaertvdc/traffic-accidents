/*! WebGLayer 2016-05-05 */
var WGL=function(){var a,b,c,d,e,f,g,h=function(){c=[],d=[],e=[],f=[]},j=function(a,b,c){var d=WGL._dimensions[a];if("undefined"==typeof d)throw"Cant set fitler to not defined dimension "+name;null==d.filters&&(d.filters=[],d.filtersids=[]),d.filters[b]=c,d.filtersids.push(b)};return{internal:{},dimension:{},filter:{},experimental:{},ui:{},filterutils:{},numrec:{},init:function(c,d,e){h(),g=this.utils,a=new WGL.internal.Manager(e),WGL.internal.GLUtils.loadShaders(d),b=new g.Rasterer(c),a.num_rec=c,a.r_size=b.size,this._mainFilter=new WGL.internal.Filter,this._dimensions=[],this.mcontroller=new WGL.internal.MapController,this.mcontroller.resize();for(var i=0;i<a.num_rec;i++)f[i]=b.calc(i);var j=g.array2TA2D(f);a.addDataBuffer(j,2,"index")},getManager:function(){return a},getRasterSize:function(){return b.size},addMapDimension:function(b,c){try{a.addDataBuffer(g.array2TA(b),2,"wPoint")}catch(d){console.warn(d)}var e=new WGL.dimension.MapDimension(c);return this._dimensions[c]=e,e},addLineDimension:function(b,c){var d=g.array2TALines(b);a.addDataBuffer(d.pts,2,"wPoint"),a.addDataBuffer(d.norm,2,"normals"),a.addElementBuffer(d.indicies,1,"indicies");var e=new WGL.dimension.LineDimension(c);return e.num=d.num,this._dimensions[c]=e,e},addHeatMapDimension:function(b,c){try{a.addDataBuffer(g.array2TA(b),2,"wPoint")}catch(d){console.warn(d)}var e=new WGL.dimension.HeatMapDimension(c);return this._dimensions[c]=e,e},addLinearHistDimension:function(b){var d=g.array2TANormLinear(b,b.num_bins);a.addDataBuffer(d,1,b.name,b.min,b.max);var e=new WGL.dimension.HistDimension(b);return this._dimensions[b.name]=e,c[b.name]=e,a.dimnum=Object.keys(c).length,e},addOrdinalHistDimension:function(b){var d=g.array2TANormOrdinal(b);a.addDataBuffer(d,1,b.name);var e=new WGL.dimension.HistDimension(b);return e.setToOrdinal(),this._dimensions[b.name]=e,c[b.name]=e,a.dimnum=Object.keys(c).length,e},addMultiDim:function(b){var c=[];for(var d in b){var e=b[d];"ordinal"==e.type?c[d]=g.array2TANormOrdinal(e):"linear"==e.type?c[d]=g.array2TANormLinear(e,e.num_bins):console.error("Dimension type missing or unknown for dim "+b)}var h=[],i=[],j=[];for(var k in c[0])for(var d in c)d=parseInt(d),j.push(f[parseInt(k)]),h.push(c[d][k]),i.push(d/(b.length-1)),0!=d&&d!=c.length-1&&(j.push(f[parseInt(k)]),h.push(c[d][k]),i.push(d/(b.length-1)));var l=g.array2TA2D(j);a.num_of_attrib=b.length,a.addDataBuffer(l,2,"indexpc"),a.addDataBuffer(new Float32Array(h),1,"td"),a.addDataBuffer(new Float32Array(i),1,"ti")},addParallelCoordinates:function(a,b){var c=new WGL.dimension.ParallelCoordinates(a,b);return this._dimensions[a]=c,c},addLinearFilter:function(a,b,c){var d=this._dimensions[a.name];null==d&&console.error("Cant set fitler to not defined dimension "+a.name);var e=new WGL.filter.LinearFilter(a,b,c);j(a.name,c,e)},addPolyBrushFilter:function(a,b){var c=this._dimensions[a];if("undefined"==typeof c)throw"Cant set fitler to not defined dimension "+a;var d=new WGL.filter.MapPolyFilter;j(a,b,d)},addColorFilter:function(a,b){var c=new WGL.filter.MapColorFilter(this._dimensions[a]);return j(a,b,c),c},addExtentFilter:function(){var a=!1;for(i in this._dimensions)this._dimensions[i].isSpatial&&(a=!0);if(!a)throw"Can not set spatial filter without spatial dimension";extf=new WGL.filter.ExtentFilter},resetFilters:function(){for(var a in d){var b=d[a];b.brush.clear()}for(var a in e){var c=e[a];c.reset()}for(var a in this._dimensions){void 0!=this._dimensions[a].reset&&this._dimensions[a].reset();for(var f in this._dimensions[a].filters)this._dimensions[a].filters[f].isActive=!1}this.setFiltersTrasholds(),this._mainFilter.applyFilterAll(this._dimensions),this.render()},addCharts:function(a){d=a},addLegend:function(a){e.push(a)},initFilters:function(){this._mainFilter.applyFilterAll(this._dimensions)},updateCharts:function(){for(var a in d)if(this._dimensions[a].visible){var b=this._dimensions[a].readPixels();"undefined"!=typeof b&&d[a].update(b)}},resize:function(){for(var a in this._dimensions){var b=this._dimensions[a];void 0!=b.resize&&b.resize()}this.render()}}}();WGL.dimension.HeatMapDimension=function(a){var b=WGL.getManager(),c=WGL.internal.GLUtils;this.id=a,this.isSpatial=!0,this.lockScale=!1,this.glProgram=c.compileShaders("heatmap_vShader","heatmap_fShader",this),this.maxcal=new WGL.internal.MaxCalculator(Math.floor(b.w/5),Math.floor(b.h/5));var d,e,f=gl.createFramebuffer(),g=!0,h=!0;this.setVisible=function(a){g=a},this.setDoGetMax=function(a){h=a},this.radiusFunction=function(a,b){return Math.pow(b,2)/10},this.maxFunction=function(a){return void 0==a?99999999:a},this.minFunction=function(a){return 0},this.gradFunction=function(){return 2},this.addLegend=function(a){e=a,e.setDimension(this)},this.createMapFramebuffer=function(){f.width=b.w,f.height=b.h;var a=gl.createRenderbuffer();this.heatTexture=gl.createTexture(),this.heatTexture.name="heat map texture",gl.getExtension("OES_texture_float")||console.log("OES_texture_float not availble -- this is legal"),gl.bindFramebuffer(gl.FRAMEBUFFER,f),gl.bindTexture(gl.TEXTURE_2D,this.heatTexture),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,f.width,f.height,0,gl.RGBA,gl.FLOAT,null),gl.bindRenderbuffer(gl.RENDERBUFFER,a),gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,f.width,f.height),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,this.heatTexture,0),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,a),gl.bindTexture(gl.TEXTURE_2D,null)},this.createMapFramebuffer();var j="drawselect",k="numfilters",l="spatsum",m="radius",n=5,o="grad";gl.useProgram(this.glProgram),b.storeUniformLoc(this.glProgram,m),b.storeUniformLoc(this.glProgram,o),b.storeUniformLoc(this.glProgram,j),b.storeUniformLoc(this.glProgram,k),b.storeUniformLoc(this.glProgram,l),gl.useProgram(null);var p,q=new WGL.dimension.HeatMapRenderer(b);this.setFilter=function(a){p=a},this.setRadius=function(a){n=a},this.setup=function(){gl.useProgram(this.glProgram),b.bindMapMatrix(this.glProgram),b.enableBufferForName(this.glProgram,"wPoint","wPoint"),b.enableBufferForName(this.glProgram,"index","index"),b.bindRasterMatrix(this.glProgram),gl.bindTexture(gl.TEXTURE_2D,this.heatTexture),gl.bindFramebuffer(gl.FRAMEBUFFER,f),gl.viewport(0,0,b.w,b.h),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),gl.disable(gl.DEPTH_TEST),gl.enable(gl.BLEND),gl.blendFunc(gl.ONE,gl.ONE),b.enableFilterTexture(this.glProgram)},this.renderData=function(a){d=a,this.setup(),gl.useProgram(this.glProgram),gl.uniform1f(this.glProgram[k],b.trasholds.allsum),this.radiusValue=this.radiusFunction(n,b.zoom),gl.uniform1f(this.glProgram[m],2*this.radiusValue),gl.uniform1f(this.glProgram[o],this.gradFunction()),gl.uniform1f(this.glProgram[l],b.trasholds.spatsum),gl.bindFramebuffer(gl.FRAMEBUFFER,f),gl.drawArrays(gl.POINTS,0,a),gl.useProgram(null),gl.bindTexture(gl.TEXTURE_2D,null),q.heatTexture=this.heatTexture,b.heatTexture=this.heatTexture};var r,s;this.render=function(a){0!=g&&(this.renderData(a),this.lockScale||(h&&(this.maxall=this.maxcal.getMax(this.heatTexture,1),b.trasholds.spatsum>0&&(this.maxsel=this.maxcal.getMax(this.heatTexture,0))),s=this.maxFunction(this.maxall),r=this.minFunction(this.maxall),this.maxVal=this.maxall,this.minVal=0),s=this.maxFunction(this.maxVal),r=this.minFunction(this.minVal),b.trasholds.spatsum>0?"undefined"!=typeof p?(q.render(r,s,p[0],p[1],this.maxsel),e.updateMaxAll(this.maxall),e.drawWithFilter(this.maxsel)):(q.render(r,s,r,s,this.maxsel),e.drawWithoutFilter(),e.updateMaxAll(this.maxsel)):(q.render(r,s,r,s,s),void 0!=e&&(e.drawWithoutFilter(),e.updateMaxAll(this.maxall))))},this.update=function(){this.renderData(d)},this.reRender=function(){this.render(d)},this.tearDown=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.bindTexture(gl.TEXTURE_2D,null),gl.useProgram(null)},this.setMatrix=function(a){b.matrices.push(a),b.mapMatrix=a},this.readPixels=function(){var a=new Uint8Array(4);gl.readPixels(0,0,1,1,gl.RGBA,gl.UNSIGNED_BYTE,a);var b=0;for(i=0;i<a.length;i++)b+=a[i];console.log(b),console.log(a)}},WGL.dimension.HeatMapRenderer=function(){var a=WGL.getManager(),b=WGL.internal.GLUtils;this.glProgram=b.compileShaders("heatmap_render_vShader","heatmap_render_fShader"),gl.useProgram(this.glProgram);var c=gl.getAttribLocation(this.glProgram,"v_texCoord"),d=gl.getUniformLocation(this.glProgram,"heatmap_raster");a.storeUniformLoc(this.glProgram,"max"),a.storeUniformLoc(this.glProgram,"min"),a.storeUniformLoc(this.glProgram,"max_filter"),a.storeUniformLoc(this.glProgram,"min_filter"),a.storeUniformLoc(this.glProgram,"colors"),a.storeUniformLoc(this.glProgram,"unselcolors"),a.storeUniformLoc(this.glProgram,"reduceSelection"),this.colors=new Float32Array(16),this.colors.set([1,0,0,1,1,1,0,1,0,1,0,1,0,0,0,1]),this.unselcolors=new Float32Array(16),this.unselcolors.set([49/256,130/256,189/256,1,158/256,202/256,225/256,1,222/256,235/256,247/256,1,0,0,0,1]);var e=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,e),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1,1,-1,-1,1]),gl.STATIC_DRAW),gl.useProgram(this.glProgram),gl.uniformMatrix4fv(this.glProgram.colors,!1,this.colors),gl.uniformMatrix4fv(this.glProgram.unselcolors,!1,this.unselcolors),gl.useProgram(null),this.setup=function(){gl.useProgram(this.glProgram),gl.bindBuffer(gl.ARRAY_BUFFER,e),gl.enableVertexAttribArray(c),gl.vertexAttribPointer(c,2,gl.FLOAT,!1,0,0),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.uniform1i(d,0),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,this.heatTexture),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.viewport(a.l,a.b,a.w,a.h),gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND),gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA)},this.render=function(a,b,c,d,e){this.setup(),gl.uniform1f(this.glProgram.max,b),gl.uniform1f(this.glProgram.min,a),gl.uniform1f(this.glProgram.max_filter,d),gl.uniform1f(this.glProgram.min_filter,c),gl.uniform1f(this.glProgram.reduceSelection,e),gl.drawArrays(gl.TRIANGLES,0,6),gl.bindTexture(gl.TEXTURE_2D,null),gl.useProgram(null)},this.tearDown=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.bindTexture(gl.TEXTURE_2D,null),gl.useProgram(null)},this.setMatrix=function(b){a.matrices.push(b),a.mapMatrix=b}},WGL.dimension.HistDimension=function(a){var b=WGL.getManager(),c=WGL.internal.GLUtils;this.isSpatial=!1;var d,e=function(b){return a.min+b*(a.max-a.min)/a.num_bins},f=function(a,b){return void 0==b?a:b.min+a*(b.max-b.min)};this.name=a.name,this.program=c.compileShaders("linearhist_vShader","linearhist_fShader",this),this.valFunction=function(a,b){return a},this.reduceFunction=function(a){a.blendFunc(a.ONE,a.ONE)},this.setValueData=function(a){this.program=c.compileShaders("linearhist_param_vShader","linearhist_param_fShader",this),d=a,gl.useProgram(this.program),b.storeUniformLoc(this.program,"numfilters"),gl.useProgram(null)},gl.useProgram(this.program),b.storeUniformLoc(this.program,"numfilters"),gl.useProgram(null);var g=gl.createFramebuffer();g.width=a.num_bins,g.height=1;var h=gl.createRenderbuffer();this.histTexture=gl.createTexture(),this.histTexture.name="histogram texture",gl.getExtension("OES_texture_float")||console.log("OES_texture_float not availble -- this is legal"),gl.bindFramebuffer(gl.FRAMEBUFFER,g),gl.bindTexture(gl.TEXTURE_2D,this.histTexture),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,g.width,g.height,0,gl.RGBA,gl.FLOAT,null),gl.bindRenderbuffer(gl.RENDERBUFFER,h),gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,g.width,g.height),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,this.histTexture,0),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,h),gl.bindTexture(gl.TEXTURE_2D,null),this.floatReader=new WGL.internal.FloatReaderHistogram(this.histTexture,g.width,g.height),this.visible=!0,this.setVisible=function(a){this.visible=a},this.render=function(c){0!=this.visible&&(gl.useProgram(this.program),gl.bindFramebuffer(gl.FRAMEBUFFER,g),gl.viewport(0,0,g.width,g.height),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),gl.disable(gl.DEPTH_TEST),gl.enable(gl.BLEND),this.reduceFunction(gl),b.enableBufferForName(this.program,"index","index"),b.enableFilterTexture(this.program),gl.uniform1f(this.program.numfilters,b.trasholds.allsum),b.enableBufferForName(this.program,a.name,"attr"),void 0!=d&&b.enableBufferForName(this.program,d.name,"value"),gl.drawArrays(gl.POINTS,0,c),gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.bindTexture(gl.TEXTURE_2D,null))},this.setToOrdinal=function(){e=function(b){return a.domain[b]}},this.setToLinear=function(){e=function(b){return(b+a.min)*(a.max-a.min)/a.num_bins}},this.readPixels=function(){gl.useProgram(this.program),this.floatReader.setup(),this.floatReader.render();var b,c=this.floatReader.readPixels();b=new Array(a.num_bins),b.max={0:0,1:0,2:0,3:0},b.sum_selected=0;for(var g=0;g<a.num_bins;g++){var h=c[g+3*a.num_bins],i=f(c[g],d),j=f(c[g+1*a.num_bins],d),k=f(c[g+2*a.num_bins],d),l={val:e(g),selected:this.valFunction(i,h),unselected:this.valFunction(j,h),out:this.valFunction(k,h)};l.selected>b.max[0]&&(b.max[0]=l.selected),l.unselected+l.selected>b.max[1]&&(b.max[1]=l.unselected+l.selected),l.out+l.unselected+l.selected>b.max[2]&&(b.max[2]=l.out+l.unselected+l.selected),b.sum_selected=b.sum_selected+l.selected,b[g]=l}return b}},WGL.dimension.MapDimension=function(a){var b=WGL.getManager(),c=WGL.internal.GLUtils;this.id=a,this.isSpatial=!0,this.glProgram=c.compileShaders("map_vShader","map_fShader",this),this.name="map";var d="zoom",e="drawselect",f="numfilters";gl.useProgram(this.glProgram),b.storeUniformLoc(this.glProgram,d),b.storeUniformLoc(this.glProgram,e),b.storeUniformLoc(this.glProgram,f),gl.useProgram(null);var g=!0;this.setVisible=function(a){g=a},this.setup=function(){return gl.useProgram(this.glProgram),gl.uniform1f(this.glProgram.numfilters,b.trasholds.allsum),b.bindMapMatrix(this.glProgram),b.enableBufferForName(this.glProgram,"wPoint","wPoint"),b.enableBufferForName(this.glProgram,"index","index"),b.bindRasterMatrix(this.glProgram),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.viewport(b.l,b.b,b.w,b.h),gl.disable(gl.DEPTH_TEST),gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),null==this.glProgram.loc&&(this.glProgram.loc=gl.getUniformLocation(this.glProgram,"zoom"),!this.glProgram.loc instanceof WebGLUniformLocation)?void console.error("Uniform set failed, uniform: "+u_name+" value "+value):void gl.uniform1f(this.glProgram.loc,b.zoom)},this.render=function(a){if(0!=g){if(this.setup(),b.enableFilterTexture(this.glProgram),null==this.glProgram.drawselect&&(this.glProgram.drawselect=gl.getUniformLocation(this.glProgram,"drawselect"),!this.glProgram.drawselect instanceof WebGLUniformLocation))return void console.error("Uniform set failed, uniform");gl.uniform1f(this.glProgram.drawselect,0),gl.drawArrays(gl.POINTS,0,a),gl.uniform1f(this.glProgram.drawselect,1),gl.drawArrays(gl.POINTS,0,a),gl.useProgram(null)}},this.tearDown=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.bindTexture(gl.TEXTURE_2D,null),gl.useProgram(null)},this.setMatrix=function(a){b.matrices.push(a),b.mapMatrix=a},this.readPixels=function(){var a=new Uint8Array(4);gl.readPixels(0,0,1,1,gl.RGBA,gl.UNSIGNED_BYTE,a);var b=0;for(i=0;i<a.length;i++)b+=a[i];console.log(b),console.log(a)}},WGL.dimension.ParallelCoordinates=function(a,b){function c(a,c){var d,e,f,g=WGL.getDimension(a.name),l=d3.svg.brush(),m=function(){var b=[];b[0]=l.extent(),b[0][0]==b[0][1]&&(b=[]),WGL.filterDim(a.name,g.filters[g.filtersids[0]].id,b)},n=function(){var b=l.extent(),c=[];c[0]=[],c[0][0]=o-b[0]/h.height*o,c[0][1]=o-b[1]/h.height*o,c[0][0]==c[0][1]&&(c=[]),WGL.filterDim(a.name,g.filters[g.filtersids[0]].id,c)};if("linear"==a.type)d=d3.scale.linear().domain([a.min,a.max]).range([h.height,0]),f=m;else if("ordinal"==a.type){d=d3.scale.ordinal().domain(a.domain).rangeRoundBands([h.height,0],.03);var o=d.domain().length;f=n}l.y(d).on("brush",f),e=d3.svg.axis().scale(d).orient("left"),j.append("g").attr("class","axis_pc axis_"+c).call(e).attr("transform","translate("+k*c+")").append("text").attr("y","-2em").attr("x","0em").style("text-anchor","middle").text(a.label),j.append("g").attr("class","brush brush_"+c).call(l).selectAll("rect").attr("width","40").attr("transform","translate("+(k*c-20)+")"),this.update=function(){k=h.width/(b.length-1),j.select("#pc_svg",h.width+i.left+i.right),j.select(".axis_"+c).attr("transform","translate("+k*c+")"),j.select(".brush_"+c).selectAll("rect").attr("transform","translate("+(k*c-20)+")")},this.reset=function(){l.clear(),f.call()}}var d=WGL.getManager(),e=WGL.internal.GLUtils,f=document.getElementById(a),g=500,h=[],i={top:50,right:120,bottom:20,left:60};this.setViewport=function(){f=document.getElementById(a);var b=f.getBoundingClientRect(),c=f.clientWidth,e=f.clientHeight;h.width=c-i.left-i.right,h.height=e-i.top-i.bottom,h.tlx=b.left+i.left,h.tly=d.body_height-b.bottom+i.bottom},this.setViewport();var j=d3.select("#"+a).append("svg").attr("id","pc_svg").attr("width",h.width+i.left+i.right).attr("height",h.height+i.top+i.bottom).append("g").attr("transform","translate("+i.left+","+i.top+")").attr("z-index",3e3).append("g"),k=h.width/(b.length-1),l=[];for(var m in b){var n=b[m];l[m]=new c(n,m)}this.glProgram=e.compileShaders("pc_vShader","pc_fShader",this);var o=new WGL.dimension.ParallelCoordinatesRenderer,p="numfilters",q=gl.createFramebuffer();d.storeUniformLoc(this.glProgram,p),this.createPCFramebuffer=function(){q.width=h.width,q.height=h.height;var a=gl.createRenderbuffer();this.pcTexture=gl.createTexture(),this.pcTexture.name="pc texture",gl.getExtension("OES_texture_float")||console.log("OES_texture_float not availble -- this is legal"),gl.bindFramebuffer(gl.FRAMEBUFFER,q),gl.bindTexture(gl.TEXTURE_2D,this.pcTexture),gl.getExtension("OES_texture_float_linear")?(gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR)):(console.log("OES_texture_float not availble -- this is legal"),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST)),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,q.width,q.height,0,gl.RGBA,gl.FLOAT,null),gl.bindRenderbuffer(gl.RENDERBUFFER,a),gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,q.width,q.height),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,this.pcTexture,0),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,a),gl.bindTexture(gl.TEXTURE_2D,null)},this.resize=function(){this.setViewport(),console.log(h.width),d3.select("#pc_svg").attr("width",h.width+i.left+i.right).attr("height",h.height+i.top+i.bottom);for(var a in l)l[a].update();this.createPCFramebuffer()},this.createPCFramebuffer(),this.reRender=function(a){g=a,o.render(h,g)},this.visible=!0,this.setVisible=function(a){this.visible=a},this.render=function(){0!=this.visible&&(gl.useProgram(this.glProgram),d.enableBuffer(this.glProgram,"indexpc"),d.enableBuffer(this.glProgram,"td"),d.enableBuffer(this.glProgram,"ti"),gl.uniform1f(this.glProgram.numfilters,d.trasholds.allsum),gl.bindFramebuffer(gl.FRAMEBUFFER,q),gl.viewport(0,0,q.width,q.height),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),gl.disable(gl.DEPTH_TEST),gl.enable(gl.BLEND),gl.blendFunc(gl.ONE,gl.ONE),d.enableFilterTexture(this.glProgram),gl.lineWidth(3),gl.drawArrays(gl.LINES,0,d.num_rec*(2*d.num_of_attrib-2)),gl.useProgram(null),o.heatTexture=this.pcTexture,o.render(h,g))},this.readPixels=function(){var a=new Uint8Array(4);gl.readPixels(0,0,1,1,gl.RGBA,gl.UNSIGNED_BYTE,a);var b=0;for(m=0;m<a.length;m++)b+=a[m];console.log(b),console.log(a)},this.createBuffer=function(a,b){for(m in a){var c=a[m];for(var d in c)c[d]}},this.reset=function(){for(m in l){var a=l[m];a.reset()}}},WGL.dimension.ParallelCoordinatesRenderer=function(){var a=WGL.getManager(),b=WGL.internal.GLUtils;this.glProgram=b.compileShaders("pc_render_vShader","pc_render_fShader"),gl.useProgram(this.glProgram);var c=gl.getAttribLocation(this.glProgram,"v_texCoord"),d=gl.getUniformLocation(this.glProgram,"heatmap_raster");a.storeUniformLoc(this.glProgram,"maximum"),a.storeUniformLoc(this.glProgram,"colors"),a.storeUniformLoc(this.glProgram,"unselcolors"),a.storeUniformLoc(this.glProgram,"u_textureSize"),this.colors=new Float32Array(16),this.colors.set([1,0,0,1,1,1,0,1,0,1,0,1,0,0,0,1]),this.unselcolors=new Float32Array(16),this.unselcolors.set([49/256,130/256,189/256,1,158/256,202/256,225/256,1,222/256,235/256,247/256,1,0,0,0,1]);var e=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,e),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1,1,-1,-1,1]),gl.STATIC_DRAW),gl.useProgram(this.glProgram),gl.uniformMatrix4fv(this.glProgram.colors,!1,this.colors),gl.uniformMatrix4fv(this.glProgram.unselcolors,!1,this.unselcolors),gl.useProgram(null),this.setup=function(a){gl.useProgram(this.glProgram),gl.bindBuffer(gl.ARRAY_BUFFER,e),gl.enableVertexAttribArray(c),gl.vertexAttribPointer(c,2,gl.FLOAT,!1,0,0),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.uniform1i(d,0),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,this.heatTexture),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.viewport(a.tlx,a.tly,a.width,a.height),gl.enable(gl.SCISSOR_TEST),gl.scissor(a.tlx,a.tly,a.width,a.height),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT),gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA)},this.render=function(a,b){this.setup(a),gl.uniform1f(this.glProgram.maximum,b),gl.uniform2f(this.glProgram.u_textureSize,a.width,a.height),gl.drawArrays(gl.TRIANGLES,0,6),gl.bindTexture(gl.TEXTURE_2D,null),gl.useProgram(null),gl.disable(gl.SCISSOR_TEST)},this.tearDown=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.bindTexture(gl.TEXTURE_2D,null),gl.useProgram(null)},this.setMatrix=function(b){a.matrices.push(b),a.mapMatrix=b}},WGL.experimental.HeatMapHistogram=function(a){this.glProgram=GLU.compileShaders("heathist_vShader","heathist_fShader",this);var b=gl.createFramebuffer();b.width=a.max_bins,b.height=1;var c=gl.createRenderbuffer();this.histTexture=gl.createTexture(),this.histTexture.name="heat map texture",gl.getExtension("OES_texture_float")||console.log("OES_texture_float not availble -- this is legal"),gl.bindFramebuffer(gl.FRAMEBUFFER,b),gl.bindTexture(gl.TEXTURE_2D,this.histTexture),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,b.width,b.height,0,gl.RGBA,gl.FLOAT,null),gl.bindRenderbuffer(gl.RENDERBUFFER,c),gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,b.width,b.height),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,this.histTexture,0),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,c),gl.bindTexture(gl.TEXTURE_2D,null);var d="heatraster",e="numfilters",f="max";gl.useProgram(this.glProgram),manager.storeUniformLoc(this.glProgram,d),manager.storeUniformLoc(this.glProgram,e),manager.storeUniformLoc(this.glProgram,"max"),gl.uniform1f(this.glProgram.numfilters,3),gl.useProgram(null),this.floatReader=new FloatReaderHistogram(this.histTexture,b.width,b.height),this.setup=function(){gl.useProgram(this.glProgram),manager.bindMapMatrix(this.glProgram),manager.enableBufferForName(this.glProgram,"wPoint","wPoint"),manager.enableBufferForName(this.glProgram,"index","index"),manager.bindRasterMatrix(this.glProgram),gl.bindTexture(gl.TEXTURE_2D,this.histTexture),gl.bindFramebuffer(gl.FRAMEBUFFER,b),gl.viewport(0,0,b.width,b.height),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),gl.disable(gl.DEPTH_TEST),gl.enable(gl.BLEND),gl.blendFunc(gl.ONE,gl.ONE),manager.enableFilterTexture(this.glProgram),gl.uniform1i(this.glProgram.heatraster,1),gl.activeTexture(gl.TEXTURE1),gl.bindTexture(gl.TEXTURE_2D,this.heatTexture)},this.render=function(a){this.setup(),gl.useProgram(this.glProgram),gl.uniform1f(this.glProgram[e],3),gl.uniform1f(this.glProgram[f],manager.max),gl.drawArrays(gl.POINTS,0,a),gl.bindTexture(gl.TEXTURE_2D,null),gl.useProgram(null),this.readPixels()},this.readPixels=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,b);var c=new Float32Array(b.width*b.height*4);gl.readPixels(0,0,b.width,b.height,gl.RGBA,gl.FLOAT,c),console.log("Heat dim:"),console.log(c),this.floatReader.setup(),this.floatReader.render();var d=this.floatReader.readPixels();console.log(d);var e=[],f=0;e[f]=new Array(a[f].num_bins),e[f].max={0:0,1:0,2:0,3:0};for(var g=0;g<a[f].num_bins;g++){var h=a[f].max/a[f].num_bins,i=f*a.max_bins*3,j={min:g*h,max:(g+1)*h,selected:d[i+g],unselected:d[i+g+1*a.max_bins],out:d[i+g+2*a.max_bins]};j.selected>e[f].max[0]&&(e[f].max[0]=j.selected),j.unselected+j.selected>e[f].max[1]&&(e[f].max[1]=j.unselected+j.selected),j.out+j.unselected+j.selected>e[f].max[2]&&(e[f].max[2]=j.out+j.unselected+j.selected),e[f][g]=j}return e}},WGL.experimental.InterpolationDimension=function(a){this.manager=a,this.buf_id=0,Dimension.call(this,a);var b=gl.createFramebuffer();b.width=a.width,b.height=a.height;var c=gl.createRenderbuffer();this.interTexture=gl.createTexture(),this.interTexture.name="Interpolation texture",gl.getExtension("OES_texture_float")||console.log("OES_texture_float not availble -- this is legal"),gl.bindFramebuffer(gl.FRAMEBUFFER,b),gl.bindTexture(gl.TEXTURE_2D,this.interTexture),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,b.width,b.height,0,gl.RGBA,gl.FLOAT,null),gl.bindRenderbuffer(gl.RENDERBUFFER,c),gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,b.width,b.height),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,this.interTexture,0),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,c),gl.bindTexture(gl.TEXTURE_2D,null),this.floatReader=new FloatRasterReader(this.interTexture,b.width,b.height);var d=new InterpolationRenderer;this.setup=function(){if(gl.useProgram(this.glProgram),this.manager.bindMapMatrix(this.glProgram),this.manager.enableBuffer(this.glProgram,"wPoint"),this.manager.enableBufferForName(this.glProgram,"attr"+this.buf_id,"attr"),this.manager.enableBuffer(this.glProgram,"xy"),gl.bindTexture(gl.TEXTURE_2D,this.interTexture),gl.bindFramebuffer(gl.FRAMEBUFFER,b),gl.viewport(0,0,a.width,a.height),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),gl.disable(gl.DEPTH_TEST),gl.enable(gl.BLEND),gl.blendFunc(gl.ONE,gl.ONE),null==this.glProgram.loc&&(this.glProgram.loc=gl.getUniformLocation(this.glProgram,"zoom"),!this.glProgram.loc instanceof WebGLUniformLocation))return void console.error("Uniform set failed, uniform: "+u_name+" value "+value);var c=map.getZoom();gl.uniform1f(this.glProgram.loc,c)},this.render=function(a){return this.setup(),null==this.glProgram.drawselect&&(this.glProgram.drawselect=gl.getUniformLocation(this.glProgram,"drawselect"),!this.glProgram.drawselect instanceof WebGLUniformLocation)?void console.error("Uniform set failed, uniform"):(gl.uniform1f(this.glProgram.drawselect,0),gl.drawArrays(gl.TRIANGLES,0,3*a),gl.uniform1f(this.glProgram.drawselect,1),gl.bindTexture(gl.TEXTURE_2D,null),gl.useProgram(null),d.intepolationTexture=this.interTexture,void d.render())},this.tearDown=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.bindTexture(gl.TEXTURE_2D,null),gl.useProgram(null)},this.setMatrix=function(b){a.matrices.push(b),a.mapMatrix=b},this.readPixel=function(a,b){var c=new Uint8Array(4);gl.readPixels(a,b,1,1,gl.RGBA,gl.UNSIGNED_BYTE,c);var d=0;for(i=0;i<c.length;i++)d+=c[i]},this.readPixelaa=function(){gl.useProgram(this.program),this.floatReader.setup(),this.floatReader.render();var a=this.floatReader.readPixel(10,10);return a}},WGL.experimental.InterpolationRenderer=function(){this.glProgram=GLU.loadShaders("interpolation_vShader","interpolation_fShader");var a=gl.getAttribLocation(this.glProgram,"v_texCoord"),b=gl.getUniformLocation(this.glProgram,"inter_raster"),c=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,c),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1,1,-1,-1,1]),gl.STATIC_DRAW),this.setup=function(){gl.useProgram(this.glProgram),gl.bindBuffer(gl.ARRAY_BUFFER,c),gl.enableVertexAttribArray(a),gl.vertexAttribPointer(a,2,gl.FLOAT,!1,0,0),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.uniform1i(b,0),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,this.intepolationTexture),gl.viewport(0,0,manager.width,manager.height),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND)},this.render=function(a){this.setup(),gl.drawArrays(gl.TRIANGLES,0,6),gl.bindTexture(gl.TEXTURE_2D,null),gl.useProgram(null)},this.tearDown=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.bindTexture(gl.TEXTURE_2D,null),gl.useProgram(null)},this.setMatrix=function(a){manager.matrices.push(a),manager.mapMatrix=a},this.readPixels=function(){gl.useProgram(this.program),gl.bindFramebuffer(gl.FRAMEBUFFER,framebuffer);var a=new Float32Array(16);gl.readPixels(5,5,framebuffer.width,framebuffer.height,gl.RGBA,gl.FLOAT,a),console.log(a)}},WGL.experimental.LineChart=function(a,b,c){function d(a,b){j.selectAll(".line").attr("d",function(c){return l(c.data,a,b)})}var e,f,g,h,i,j,k=null;this.init=function(){function d(){var a=o.extent(),b=f(a[0])/m,c=f(a[1])/m;renderDetChart(1/(c-b),(c+b)/2-.5,a[0],a[1])}var l={top:20,right:20,bottom:30,left:50},m=550-l.left-l.right,n=250-l.top-l.bottom;d3.time.format("%d-%b-%y").parse;f=d3.time.scale().range([0,m]),g=d3.scale.linear().range([n,0]);d3.scale.category10();h=d3.svg.axis().scale(f).orient("bottom"),i=d3.svg.axis().scale(g).orient("left");d3.svg.line().x(function(a){return f(a.date)}).y(function(a){return g(0==a.value?0:a.value)});if(e=d3.select("#"+a).append("svg").attr("width",m+l.left+l.right).attr("height",n+l.top+l.bottom).append("g").attr("transform","translate("+l.left+","+l.top+")"),f.domain(b),g.domain([210,240]),e.append("g").attr("class","x axis").attr("transform","translate(0,"+n+")").call(h),e.append("g").attr("class","y axis").call(i).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text("level [m]"),j=e.append("g").attr("class","chart_lines"),c){var o=d3.svg.brush().x(f).extent(0,0).on("brushstart",d).on("brush",d).on("brushend",d),p=e.append("g").attr("class","brush").call(o);p.selectAll("rect").attr("height",n)}j.selectAll("g").data(k).enter().append("path").attr("class","line").attr("id",function(a){return"line"+a.uid}).style("stroke",function(a){return a.col})};var l=function(a,b,c){var d=[],e=!1;a.forEach(function(a){0==a.numrec?a.av_value=NaN:(a.av_value=a.value/a.numrec,a.date=new Date(a.date*b+c))});for(var h=0;h<a.length;h++){var i=a[h];
e?isNaN(i.av_value)||isNaN(a[h-1].av_value)?!isNaN(i.av_value)&&isNaN(a[h-1].av_value)?(d.push("M"),d.push(f(i.date).toFixed(3)),d.push(","),d.push(g(i.av_value).toFixed(3))):isNaN(i.av_value)&&isNaN(a[h-1].av_value):(d.push("L"),d.push(f(i.date).toFixed(3)),d.push(","),d.push(g(i.av_value).toFixed(3))):isNaN(i.av_value)||(d.push("M"),d.push(f(i.date).toFixed(3)),d.push(","),d.push(g(i.av_value).toFixed(3)),e=!0)}return d.join("")};this.updatePart=function(a,c,g){1/(b[1].getTime()-b[0].getTime);null==k&&(k=Array.prototype.slice.call(a),this.init()),j.selectAll("g").datum(k),f.domain([c,g]),h.scale(f),e.selectAll(".x.axis").transition().duration(30).call(h);var i=(g.getTime()-c.getTime())/k[0].data.length,l=c.getTime();d(i,l)},this.update=function(a){null==k&&(k=Array.prototype.slice.call(a),this.init()),k=Array.prototype.slice.call(a),j.selectAll("g").datum(k);var c=(b[1].getTime()-b[0].getTime())/k[0].data.length,e=b[0].getTime();d(c,e)}},WGL.experimental.LineChartDimension=function(a,b){var a=a;this.program=GLU.compileShaders("lineChart_vShader","lineChart_fShader",this);var c=gl.createFramebuffer();c.width=b,c.height=1;var d=gl.createRenderbuffer();this.lineTexture=gl.createTexture(),this.lineTexture.name="line chart texture",gl.getExtension("OES_texture_float")||console.log("OES_texture_float not availble -- this is legal"),gl.bindFramebuffer(gl.FRAMEBUFFER,c),gl.bindTexture(gl.TEXTURE_2D,this.lineTexture),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,c.width,c.height,0,gl.RGBA,gl.FLOAT,null),gl.bindRenderbuffer(gl.RENDERBUFFER,d),gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,c.width,c.height),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,this.lineTexture,0),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,d),gl.bindTexture(gl.TEXTURE_2D,null),this.floatReader=new FloatRasterReader(this.lineTexture,c.width,c.height),this.render=function(b,d,e){return gl.useProgram(this.program),gl.bindFramebuffer(gl.FRAMEBUFFER,c),gl.viewport(0,0,c.width,c.height),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),gl.disable(gl.DEPTH_TEST),gl.enable(gl.BLEND),gl.blendFunc(gl.ONE,gl.ONE),a.enableBufferForName(this.program,"findex","findex"),a.enableBufferForName(this.program,b,"attr"),null==this.program.locz&&(this.program.locz=gl.getUniformLocation(this.program,"zoom"),!this.program.loc instanceof WebGLUniformLocation)?void console.error("Uniform set failed, uniform: "+u_name+" value "+value):(gl.uniform1f(this.program.locz,d),null==this.program.loct&&(this.program.loct=gl.getUniformLocation(this.program,"translate"),!this.program.loct instanceof WebGLUniformLocation)?void console.error("Uniform set failed, uniform: "+u_name+" value "+value):(gl.uniform1f(this.program.loct,e),gl.drawArrays(gl.POINTS,0,a.num_frames),gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.bindFramebuffer(gl.FRAMEBUFFER,null),void gl.bindTexture(gl.TEXTURE_2D,null)))},this.readPixels=function(){gl.useProgram(this.program),this.floatReader.setup(),this.floatReader.render();for(var a=this.floatReader.readPixels(),d=[],d=[],e=0;b>e;e++){var f=[];f.value=a[e],f.date=e,f.numrec=a[b+e],f.nan=a[2*b+e],d[e]=f}return d.width=c.width,d}},WGL.dimension.LineDimension=function(a){var b=WGL.getManager(),c=WGL.internal.GLUtils;this.id=a,this.isSpatial=!0,this.glProgram=c.compileShaders("fatline_vShader","fatline_fShader",this),this.name="map";var d="zoom",e="drawselect",f="numfilters";gl.useProgram(this.glProgram),b.storeUniformLoc(this.glProgram,d),b.storeUniformLoc(this.glProgram,e),b.storeUniformLoc(this.glProgram,f),gl.useProgram(null);var g=!0;this.setVisible=function(a){g=a},this.setup=function(){return gl.useProgram(this.glProgram),gl.uniform1f(this.glProgram.numfilters,b.trasholds.allsum),b.bindMapMatrix(this.glProgram),b.enableBufferForName(this.glProgram,"wPoint","wPoint"),b.enableBufferForName(this.glProgram,"normals","normals"),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,b.databuffers.indicies),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.viewport(b.l,b.b,b.w,b.h),gl.disable(gl.DEPTH_TEST),gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),null==this.glProgram.loc&&(this.glProgram.loc=gl.getUniformLocation(this.glProgram,"zoom"),!this.glProgram.loc instanceof WebGLUniformLocation)?void console.error("Uniform set failed, uniform: "+u_name+" value "+value):void gl.uniform1f(this.glProgram.loc,b.zoom)},this.render=function(a){return 0!=g?(this.setup(),null==this.glProgram.drawselect&&(this.glProgram.drawselect=gl.getUniformLocation(this.glProgram,"drawselect"),!this.glProgram.drawselect instanceof WebGLUniformLocation)?void console.error("Uniform set failed, uniform"):void gl.drawElements(gl.TRIANGLES,this.num,gl.UNSIGNED_SHORT,0)):void 0},this.tearDown=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.bindTexture(gl.TEXTURE_2D,null),gl.useProgram(null)},this.setMatrix=function(a){b.matrices.push(a),b.mapMatrix=a},this.readPixels=function(){var a=new Uint8Array(4);gl.readPixels(0,0,1,1,gl.RGBA,gl.UNSIGNED_BYTE,a);var b=0;for(i=0;i<a.length;i++)b+=a[i];console.log(b),console.log(a)}},WGL.experimental.MapLineDimension=function(a){this.manager=a,Dimension.call(this,a),this.setup=function(){if(gl.useProgram(this.glProgram),a.bindMapMatrix(this.glProgram),a.enableBufferForName(this.glProgram,"wPoint"+a.year,"wPoint"),a.enableBufferForName(this.glProgram,"attr"+a.year+a.time,"attr"),a.enableBufferForName(this.glProgram,"index"+a.year+"Line","index"),a.enableFilterTexture(this.glProgram),a.bindRasterMatrix(this.glProgram),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.viewport(0,0,a.width,a.height),gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND),null==this.glProgram.loc&&(this.glProgram.loc=gl.getUniformLocation(this.glProgram,"zoom"),!this.glProgram.loc instanceof WebGLUniformLocation))return void console.error("Uniform set failed, uniform: "+u_name+" value "+value);var b=map.getZoom();if(b>8){var c=(b-7)/2;gl.uniform1f(this.glProgram.loc,c)}else gl.uniform1f(this.glProgram.loc,1)},this.bindDrawSelect=function(a){return null==this.glProgram.drawselect&&(this.glProgram.drawselect=gl.getUniformLocation(this.glProgram,"drawselect"),!this.glProgram.drawselect instanceof WebGLUniformLocation)?void console.error("Uniform set failed, uniform: drawselect value "+a):void gl.uniform1f(this.glProgram.drawselect,a)},this.render=function(b){this.setup(),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),this.bindDrawSelect(0),gl.lineWidth(1),gl.drawArrays(gl.LINES,0,2*a.num_rec),this.bindDrawSelect(1),gl.lineWidth(4),gl.drawArrays(gl.LINES,0,2*a.num_rec),gl.useProgram(null)},this.tearDown=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.bindTexture(gl.TEXTURE_2D,null),gl.useProgram(null)},this.setMatrix=function(b){a.matrices.push(b),a.mapMatrix=b},this.readPixels=function(){var a=new Uint8Array(4);gl.readPixels(0,0,1,1,gl.RGBA,gl.UNSIGNED_BYTE,a);var b=0;for(i=0;i<a.length;i++)b+=a[i];console.log(b),console.log(a)}},WGL.experimental.SDLineChartDimension=function(a,b){var a=a;this.program=utils.loadShaders("sdlineChart_vShader","sdlineChart_fShader",this);var c=gl.createFramebuffer();c.width=b,c.height=1;var d=gl.createRenderbuffer();this.lineTexture=gl.createTexture(),this.lineTexture.name="line chart texture",gl.getExtension("OES_texture_float")||console.log("OES_texture_float not availble -- this is legal"),gl.bindFramebuffer(gl.FRAMEBUFFER,c),gl.bindTexture(gl.TEXTURE_2D,this.lineTexture),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,c.width,c.height,0,gl.RGBA,gl.FLOAT,null),gl.bindRenderbuffer(gl.RENDERBUFFER,d),gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,c.width,c.height),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,this.lineTexture,0),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,d),gl.bindTexture(gl.TEXTURE_2D,null),this.floatReader=new FloatRasterReader(this.lineTexture,c.width,c.height);var e=gl.getUniformLocation(this.program,"lineRaster");this.render=function(){gl.useProgram(this.program),gl.bindFramebuffer(gl.FRAMEBUFFER,c),gl.viewport(0,0,c.width,c.height),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),gl.disable(gl.DEPTH_TEST),gl.enable(gl.BLEND),gl.blendFunc(gl.ONE,gl.ONE),a.enableBufferForName(this.program,"findex","findex"),a.enableBufferForName(this.program,"attr","attr"),gl.uniform1i(e,0),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,this.lineChartTexture),gl.drawArrays(gl.POINTS,0,a.num_frames),gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.bindTexture(gl.TEXTURE_2D,null)},this.readPixels=function(){gl.useProgram(this.program),gl.bindFramebuffer(gl.FRAMEBUFFER,c);var a=new Float32Array(c.width*c.height*4);gl.readPixels(0,0,c.width,c.height,gl.RGBA,gl.FLOAT,a),console.log("HistDim:"),console.log(a),this.floatReader.setup(),this.floatReader.render();var a=this.floatReader.readPixels(),d=[];console.log(a);for(var d=[],e=0;b>e;e++){var f=[];f.value=a[e],f.date=e,f.numrec=a[b+e],d[e]=f}return d}},WGL.experimental.SVGCanvas=function(){this.s=100;var a=d3.select("body").append("svg").attr("id","svgcanvas").attr("width",manager.width).attr("height",manager.height),b=a.append("g");this.addPoints=function(a){circles=b.selectAll("circle").data(a).enter().append("circle"),circles.attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y}).attr("r",.005).attr("class","point").attr("pointer-events","all").style("fill",function(a){return a.col}).on("mouseover",function(){console.log("aaa")})},this.transform=function(a,c){this.s=Math.pow(2,a),b.attr("transform","matrix("+this.s+",0,0,"+this.s+","+-c.x*this.s+","+-c.y*this.s+")")}},WGL.experimental.WGLOld=function(a,b,c){function d(){var a={allsum:0,spatsum:0},b=0;for(var c in p)for(var d in p[c].filters){var d=p[c].filters[d];d.isActive?(d.index=b,a.allsum=a.allsum+Math.pow(2,b),p[c].isSpatial&&(a.spatsum=a.spatsum+Math.pow(2,b),l.spIndex=b),b++):p[c].isSpatial&&(l.spIndex=-1)}l.trasholds=a}function e(a){pts_ar=new Float32Array(a.data.length);var b=0;a.num_bins=a.domain.length,a.min=0,a.max=a.num_bins;for(var b in a.data){var c=a.domain.indexOf(a.data[b]);-1==c?(console.warn("data out of range "+a.data[b]),val=-1):val=(c+.5)/a.num_bins,pts_ar[b]=val}return pts_ar}function f(a,b){pts_ar=new Float32Array(a.data.length);var c=0;for(var c in a.data)isNaN(a.data[c])?val=0:val=(a.data[c]-a.min)/(a.max-a.min)*a.num_bins/b,pts_ar[c]=val;return pts_ar}function g(a){pts_ar=new Float32Array(2*a.length);for(var b=0,c=0,b=0;b<a.length;b++)pts_ar[c++]=a[b][0],pts_ar[c++]=a[b][1];return pts_ar}function h(a){pts_ar=new Float32Array(a.length);for(var b=0,b=0;b<a.length;b++)pts_ar[b]=a[b],a[b]=null;return pts_ar}function i(a){this.size=Math.ceil(Math.sqrt(a)),this.calc=function(a){var b=Math.floor(a/this.size),c=a-this.size*b;return[j(c,this.size),j(b,this.size)]}}function j(a,b){return a/b*2-1+2/(2*b)}GLU.loadShaders(b);var k=a,l=new Manager(c),m=new i(k);l.num_rec=k,l.index="index",l.r_size=m.size,l.wgl=this,l.filternum=0,this.mcontroller=new MapController(l),this.mcontroller.resize();for(var n,o,p=[],q=[],r=[],s=[],t=new Filter(l),u=[],v=0;k>v;v++)u[v]=m.calc(v);var w=g(u);l.addDataBuffer(w,2,"index"),GLU.manager=l,this.addMapDimension=function(a,b){try{l.addDataBuffer(h(a),2,"wPoint")}catch(c){console.warn(c)}var d=new MapDimension(l,b);return p[b]=d,d},this.resize=function(){for(var a in p){var b=p[a];void 0!=b.resize&&b.resize()}this.render()},this.addLegend=function(a){q.push(a)},this.addHeatMapDimension=function(a,b){try{l.addDataBuffer(h(a),2,"wPoint")}catch(c){console.warn(c)}var d=new HeatMapDimension(l,b);return p[b]=d,d},this.getDimensions=function(){return p},this.getDimension=function(a){return p[a]},this.addParallelCoordinates=function(a,b){var c=new ParallelCoordinates(l,a,b);return p[a]=c,c},this.addLinearHistDimension=function(a){this.addData(a);var b=new HistDimension(l,a);return p[a.name]=b,r[a.name]=b,l.dimnum=Object.keys(r).length,b},this.addData=function(a){var b=f(a,a.num_bins);l.addDataBuffer(b,1,a.name,a.min,a.max)},this.addOrdinalHistDimension=function(a){var b=e(a);l.addDataBuffer(b,1,a.name);var c=new HistDimension(l,a);return c.setToOrdinal(),p[a.name]=c,r[a.name]=c,l.dimnum=Object.keys(r).length,c},this.addMultiDim=function(a){var b=[];for(var c in a){var d=a[c];"ordinal"==d.type?b[c]=e(d):"linear"==d.type?b[c]=f(d,d.num_bins):console.error("Dimension type missing or unknown for dim "+a)}var h=[],i=[],j=[];for(var k in b[0])for(var c in b)c=parseInt(c),j.push(u[parseInt(k)]),h.push(b[c][k]),i.push(c/(a.length-1)),0!=c&&c!=b.length-1&&(j.push(u[parseInt(k)]),h.push(b[c][k]),i.push(c/(a.length-1)));var m=g(j);l.num_of_attrib=a.length,l.addDataBuffer(m,2,"indexpc"),l.addDataBuffer(new Float32Array(h),1,"td"),l.addDataBuffer(new Float32Array(i),1,"ti")},this.addLinearFilter=function(a,b,c){var d=p[a.name];null==d&&console.error("Cant set fitler to not defined dimension "+a.name);var e=new LinearFilter(l,a,b,c);x(a.name,c,e)},this.addPolyBrushFilter=function(a,b){var c=p[a];if("undefined"==typeof c)throw"Cant set fitler to not defined dimension "+a;var d=new MapPolyFilter(l);x(a,b,d)},this.addColorFilter=function(a,b){var c=new MapColorFilter(l,p[a]);return x(a,b,c),c};var x=function(a,b,c){var d=p[a];if("undefined"==typeof d)throw"Cant set fitler to not defined dimension "+name;null==d.filters&&(d.filters=[],d.filtersids=[]),d.filters[b]=c,d.filtersids.push(b)};this.addExtentFilter=function(){var a=!1;for(v in p)p[v].isSpatial&&(a=!0);if(!a)throw"Can not set spatial filter without spatial dimension";o=new ExtentFilter(l)},this.addCharts=function(a){s=a},this.getManager=function(){return l},this.render=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.viewport(0,0,l.w,l.h),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);for(var a in p)p[a].render(k);this.updateCharts()},this.updateLegends=function(){for(var a in q)q[a].update()};this.initFilters=function(){t.applyFilterAll(p)},this.updateSizeOfMapDimensions=function(){for(var a in p){var b=p[a];if("undefined"!=typeof b.createMapFramebuffer&&b.createMapFramebuffer(),"undefined"!=typeof b.filters)for(var a in b.filters)"undefined"!=typeof b.filters[a].createMapFramebuffer&&b.filters[a].createMapFramebuffer()}},this.updateCharts=function(){for(var a in s){var b=p[a].readPixels();"undefined"!=typeof b&&s[a].update(b)}},this.filterByExt=function(){var a=!1;for(var b in p)if(p[b].isSpatial){for(var c in p[b].filters){var e=p[b].filters[c];e.isActive&&(e.updateFilter(),a=!0)}a&&(d(),t.applyFilterAll(p),n=void 0)}"undefined"!=typeof o&&o.render(),this.render()},this.filterDim=function(a,b,c,d){var e=p[a].filters[b];return 0==c.length?(this.filterDeleted(a,b),void(n=void 0)):(c.length>0&&(b!=n||"undefined"==typeof n)&&(console.log("filter changed"),n=b,this.filterChanged(a,n)),e.createFilteringData(c),e.renderFilter(),t.applyFilterDim(p[a],b),void(void 0!=d&&1!=d||(this.render(),this.updateCharts())))},this.filterChanged=function(a,b){p[a].filters[b].isActive=!0,d(),p[a].filters[b].isActive=!1,t.applyFilterAll(p),t.switchTextures(),p[a].filters[b].isActive=!0,"undefined"!=typeof o&&o.render()},this.filterDeleted=function(a,b){p[a].filters[b].isActive=!1,d(),t.applyFilterAll(p),"undefined"!=typeof o&&o.render(),this.render(),this.updateCharts()}},WGL.filter.ExtentFilter=function(){var a=WGL.getManager(),b=WGL.internal.GLUtils;this.rastersize=a.r_size,this.filterProgram=b.compileShaders("extent_vShader","extent_fShader",this),this.render=function(){var b=a.getFilter().getActiveFB();gl.useProgram(this.filterProgram),gl.bindFramebuffer(gl.FRAMEBUFFER,b),gl.viewport(0,0,b.width,b.height),gl.disable(gl.DEPTH_TEST),gl.enable(gl.BLEND),gl.blendFuncSeparate(gl.ZERO,gl.ONE,gl.ONE,gl.ZERO),a.bindMapMatrix(this.filterProgram),a.enableBufferForName(this.filterProgram,"wPoint","wPoint"),a.enableBufferForName(this.filterProgram,"index","index"),gl.drawArrays(gl.POINTS,0,a.num_rec),gl.useProgram(null),gl.bindRenderbuffer(gl.RENDERBUFFER,null),gl.bindFramebuffer(gl.FRAMEBUFFER,null)},this.readPixels=function(){var b=a.getFilter().getActiveFB();gl.bindFramebuffer(gl.FRAMEBUFFER,b);var c=new Uint8Array(b.width*b.height*4);gl.readPixels(0,0,b.width,b.height,gl.RGBA,gl.UNSIGNED_BYTE,c),gl.bindFramebuffer(gl.FRAMEBUFFER,null),console.log(c);for(var d=[],e=0;e<c.length;e+=1)d.push(c[e]);return console.log("extent buffer: "+d),d}},WGL.filter.LinearFilter=function(a,b,c){var d=(WGL.getManager(),WGL.internal.GLUtils);this.isspatial=0,this.id=c;var e,f=(new Float32Array([-1.1,0,1.1,0]),1);this.filterProgram=d.compileShaders("histFilter_vShader","histFilter_fShader",this),this.filterProgram.name="HistFitler";var g=gl.createBuffer();g.attr="FilterLines";var h=gl.createFramebuffer(),i=gl.createRenderbuffer();this.filterTexture=gl.createTexture(),this.filterTexture.name="hist filter texture",gl.bindFramebuffer(gl.FRAMEBUFFER,h),gl.bindTexture(gl.TEXTURE_2D,this.filterTexture),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,b,f,0,gl.RGBA,gl.UNSIGNED_BYTE,null),gl.bindRenderbuffer(gl.RENDERBUFFER,i),gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,b,f),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,this.filterTexture,0),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,i),gl.bindRenderbuffer(gl.RENDERBUFFER,null),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.bindTexture(gl.TEXTURE_2D,null),this.renderFilter=function(){return gl.useProgram(this.filterProgram),gl.bindTexture(gl.TEXTURE_2D,this.filterTexture),gl.bindFramebuffer(gl.FRAMEBUFFER,h),gl.viewport(0,0,b,f),this.bindFilters(),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),gl.bindBuffer(gl.ARRAY_BUFFER,g),null==this.filterProgram[g.attr]&&(this.filterProgram[g.attr]=gl.getAttribLocation(this.filterProgram,g.attr)),this.filterProgram[g.attr]>=0?(gl.enableVertexAttribArray(this.filterProgram[g.attr]),gl.vertexAttribPointer(this.filterProgram[g.attr],2,gl.FLOAT,!1,0,0),gl.drawArrays(gl.LINES,0,pointsSize),gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.bindFramebuffer(gl.FRAMEBUFFER,null),void gl.bindTexture(gl.TEXTURE_2D,null)):void console.error("Error binding buffer: "+g)},this.updateFilter=function(a){},this.createFilteringData=function(b){for(var c=[],d=b,f=0,g=0;g<d.length;g++)c[f++]=2*((d[g][0]-a.min)/(a.max-a.min))-1,c[f++]=0,c[f++]=2*((d[g][1]-a.min)/(a.max-a.min))-1,c[f++]=0;e=new Float32Array(c)},this.bindFilters=function(){gl.bindBuffer(gl.ARRAY_BUFFER,g),gl.bufferData(gl.ARRAY_BUFFER,e,gl.STATIC_DRAW),gl.bindBuffer(gl.ARRAY_BUFFER,null),pointsSize=e.length/2},this.readPixels=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,h);var a=new Uint8Array(b*f*4);gl.readPixels(0,0,b,f,gl.RGBA,gl.UNSIGNED_BYTE,a),sum=0,console.log(a),gl.bindFramebuffer(gl.FRAMEBUFFER,null)}},WGL.filter.MapColorFilter=function(a){var b=WGL.getManager(),c=WGL.internal.GLUtils;this.isspatial=1;this.glProgram=c.compileShaders("mapColorFilter_vShader","mapColorFilter_fShader",this);var d=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,d),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1,1,-1,-1,1]),gl.STATIC_DRAW),gl.bindBuffer(gl.ARRAY_BUFFER,null);var e=gl.createFramebuffer(),f=gl.createRenderbuffer();this.filterTexture=gl.createTexture(),this.filterTexture.name="color filter texture";var g=gl.getAttribLocation(this.glProgram,"v_texCoord"),h=gl.getUniformLocation(this.glProgram,"heatmap_raster");b.storeUniformLoc(this.glProgram,"val_min"),b.storeUniformLoc(this.glProgram,"val_max"),this.filter_val=[-(1/0),1/0],this.createMapFramebuffer=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,e),gl.bindTexture(gl.TEXTURE_2D,this.filterTexture),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,b.w,b.h,0,gl.RGBA,gl.UNSIGNED_BYTE,null),gl.bindRenderbuffer(gl.RENDERBUFFER,f),gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,b.width,b.height),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,this.filterTexture,0),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,f),gl.bindRenderbuffer(gl.RENDERBUFFER,null),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.bindTexture(gl.TEXTURE_2D,null)},this.createMapFramebuffer(),this.setup=function(){gl.useProgram(this.glProgram),gl.bindBuffer(gl.ARRAY_BUFFER,d),gl.enableVertexAttribArray(g),gl.vertexAttribPointer(g,2,gl.FLOAT,!1,0,0),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.uniform1i(h,0),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,b.heatTexture),gl.bindFramebuffer(gl.FRAMEBUFFER,e),gl.viewport(0,0,b.w,b.h),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND)},this.renderFilter=function(){this.setup(),gl.drawArrays(gl.TRIANGLES,0,6),gl.bindTexture(gl.TEXTURE_2D,null),gl.useProgram(null)},this.updateFilter=function(){a.update(),this.createFilteringData(this.saved_filter),this.renderFilter()},this.createFilteringData=function(a){this.saved_filter=a,console.log("filter: "+a),gl.useProgram(this.glProgram),gl.uniform1f(this.glProgram.val_min,a[0]),gl.uniform1f(this.glProgram.val_max,a[1])},this.readPixels=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,e);var a=new Uint8Array(this.width*this.height*4);for(gl.readPixels(0,0,this.width,this.height,gl.RGBA,gl.UNSIGNED_BYTE,a),sum=0,i=0;i<a.length;i++)sum+=a[i];gl.bindFramebuffer(gl.FRAMEBUFFER,null)}},WGL.filter.MapPolyFilter=function(){var a=WGL.getManager(),b=WGL.internal.GLUtils;this.isspatial=1;var c=0;this.filterProgram=b.compileShaders("mapFilter_vShader","mapFilter_fShader",this);var d=gl.createBuffer();d.attr="poly";var e=gl.createFramebuffer(),f=gl.createRenderbuffer();this.filterTexture=gl.createTexture(),this.filterTexture.name="filter texture",this.createMapFramebuffer=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,e),gl.bindTexture(gl.TEXTURE_2D,this.filterTexture),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,a.w,a.h,0,gl.RGBA,gl.UNSIGNED_BYTE,null),gl.bindRenderbuffer(gl.RENDERBUFFER,f),gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,a.width,a.height),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,this.filterTexture,0),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,f),gl.bindRenderbuffer(gl.RENDERBUFFER,null),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.bindTexture(gl.TEXTURE_2D,null)},this.createMapFramebuffer(),this.renderFilter=function(){return gl.useProgram(this.filterProgram),a.bindMapMatrix(this.filterProgram),gl.bindTexture(gl.TEXTURE_2D,this.filterTexture),gl.bindFramebuffer(gl.FRAMEBUFFER,e),gl.viewport(0,0,a.w,a.h),gl.clearColor(0,0,0,1),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),gl.bindBuffer(gl.ARRAY_BUFFER,d),null==this.filterProgram[d.attr]&&(this.filterProgram[d.attr]=gl.getAttribLocation(this.filterProgram,d.attr)),this.filterProgram[d.attr]>=0?(gl.enableVertexAttribArray(this.filterProgram[d.attr]),gl.vertexAttribPointer(this.filterProgram[d.attr],2,gl.FLOAT,!1,0,0),gl.drawArrays(gl.TRIANGLES,0,c),gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.bindFramebuffer(gl.FRAMEBUFFER,null),void gl.bindTexture(gl.TEXTURE_2D,null)):void console.error("Error binding buffer: "+d)},this.updateFilter=function(){this.createFilteringData(this.saved_filter),this.renderFilter()},this.createFilteringData=function(a){this.saved_filter=a;var b=new Array;for(var e in a)b.push.apply(b,a[e]);var f=new Float32Array(b);gl.bindBuffer(gl.ARRAY_BUFFER,d),gl.bufferData(gl.ARRAY_BUFFER,f,gl.STATIC_DRAW),gl.bindBuffer(gl.ARRAY_BUFFER,null),c=b.length/2},this.readPixels=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,e);var a=new Uint8Array(this.width*this.height*4);for(gl.readPixels(0,0,this.width,this.height,gl.RGBA,gl.UNSIGNED_BYTE,a),sum=0,i=0;i<a.length;i++)sum+=a[i];gl.bindFramebuffer(gl.FRAMEBUFFER,null)}},WGL.internal.Filter=function(){function a(a){gl.bindFramebuffer(gl.FRAMEBUFFER,g[a]),gl.bindTexture(gl.TEXTURE_2D,i[a]),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,g.width,g.height,0,gl.RGBA,gl.UNSIGNED_BYTE,null),gl.bindRenderbuffer(gl.RENDERBUFFER,h[a]),gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,g.width,g.height),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,i[a],0),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,h[a]),gl.viewport(0,0,g.width,g.height),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),gl.bindTexture(gl.TEXTURE_2D,null),gl.bindRenderbuffer(gl.RENDERBUFFER,null),gl.bindFramebuffer(gl.FRAMEBUFFER,null)}var b=WGL.getManager(),c=WGL.internal.GLUtils;b.setFilter(this),this.rastersize=b.r_size,this.lastDim="",this.filterProgram=c.compileShaders("filter_vShader","filter_fShader",this);var d="filterid";b.storeUniformLoc(this.filterProgram,d);var e="indexText";b.storeUniformLoc(this.filterProgram,e);var f="isspatial";b.storeUniformLoc(this.filterProgram,f),this.filterProgram.name="Main filter";var g=[],h=[],i=[];g.width=WGL.getRasterSize(),g.height=WGL.getRasterSize(),i[0]=gl.createTexture(),i[1]=gl.createTexture(),g[0]=gl.createFramebuffer(),g[1]=gl.createFramebuffer(),h[0]=gl.createRenderbuffer(),h[1]=gl.createRenderbuffer(),g[0].width=this.rastersize,g[0].height=this.rastersize,g[0].id=0,g[1].width=this.rastersize,g[1].height=this.rastersize,g[1].id=1;var j=0,k=1;a(1),a(0),this.applyFilterAll=function(a){for(var c in a)for(var d in a[c].filters){var e=a[c].filters[d];e.isActive}gl.useProgram(this.filterProgram),gl.bindFramebuffer(gl.FRAMEBUFFER,g[k]),gl.viewport(0,0,g.width,g.height),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),gl.bindFramebuffer(gl.FRAMEBUFFER,g[j]),gl.viewport(0,0,g.width,g.height),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),gl.disable(gl.DEPTH_TEST),gl.enable(gl.BLEND),gl.blendFunc(gl.ONE,gl.ONE),b.bindMapMatrix(this.filterProgram),b.enableBufferForName(this.filterProgram,"index","index");for(var c in a)for(var d in a[c].filters){var e=a[c].filters[d];e.isActive&&(gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,e.filterTexture),gl.uniform1i(this.filterProgram.histLoc,0),gl.activeTexture(gl.TEXTURE1),gl.bindTexture(gl.TEXTURE_2D,i[k]),gl.uniform1i(this.filterProgram.indexText,1),gl.uniform1f(this.filterProgram.filterid,e.index),gl.uniform1f(this.filterProgram.isspatial,e.isspatial),0==e.isspatial?b.enableBufferForName(this.filterProgram,a[c].name,"attr1"):b.enableBufferForName(this.filterProgram,"wPoint","wPoint"),gl.drawArrays(gl.POINTS,0,b.num_rec))}gl.useProgram(null),gl.bindRenderbuffer(gl.RENDERBUFFER,null),gl.bindFramebuffer(gl.FRAMEBUFFER,null)},this.applyFilterDim=function(a,c){gl.useProgram(this.filterProgram),gl.bindFramebuffer(gl.FRAMEBUFFER,g[j]),gl.viewport(0,0,g.width,g.height),gl.disable(gl.DEPTH_TEST),gl.enable(gl.BLEND),gl.blendFuncSeparate(gl.ONE,gl.ZERO,gl.ONE,gl.ONE),b.bindMapMatrix(this.filterProgram),b.enableBufferForName(this.filterProgram,"index","index"),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,a.filters[c].filterTexture),gl.uniform1i(this.filterProgram.histLoc,0),gl.activeTexture(gl.TEXTURE1),gl.bindTexture(gl.TEXTURE_2D,i[k]),gl.uniform1i(this.filterProgram.indexText,1),gl.uniform1f(this.filterProgram.filterid,a.filters[c].index),gl.uniform1f(this.filterProgram.isspatial,a.filters[c].isspatial),0==a.filters[c].isspatial?b.enableBufferForName(this.filterProgram,a.name,"attr1"):b.enableBufferForName(this.filterProgram,"wPoint","wPoint"),gl.drawArrays(gl.POINTS,0,b.num_rec),gl.useProgram(null),gl.bindRenderbuffer(gl.RENDERBUFFER,null),gl.bindFramebuffer(gl.FRAMEBUFFER,null)},this.getActiveTexture=function(){return i[j]},this.getActiveFB=function(){return g[j]},this.getPassiveFB=function(){return g[k]},this.switchTextures=function(){0==j?(j=1,k=0):(j=0,k=1)},this.readPixelsAll=function(){this.readPixels(k,"pasive id:"),this.readPixels(j,"active id:")},this.readPixels=function(a,b){gl.bindFramebuffer(gl.FRAMEBUFFER,g[a]);var c=new Uint8Array(g.width*g.height*4);gl.readPixels(0,0,g.width,g.height,gl.RGBA,gl.UNSIGNED_BYTE,c),gl.bindFramebuffer(gl.FRAMEBUFFER,null);for(var d=[],e=0;e<c.length;e+=1)d.push(c[e]);return console.log(b+" buffer: "+d),d}},WGL.internal.FloatRasterReader=function(a,b){this.glProgram=WGL.internal.GLUtils.compileShaders("float_reader_vShader","float_reader_fShader",this);var c=gl.createFramebuffer();c.width=a,c.height=b;var d=gl.createRenderbuffer();this.maxTexture=gl.createTexture(),this.maxTexture.name="max",gl.getExtension("OES_texture_float")||console.log("OES_texture_float not availble -- this is legal"),gl.bindFramebuffer(gl.FRAMEBUFFER,c),gl.bindTexture(gl.TEXTURE_2D,this.maxTexture),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,c.width,c.height,0,gl.RGBA,gl.UNSIGNED_BYTE,null),gl.bindRenderbuffer(gl.RENDERBUFFER,d),gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,c.width,c.height),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,this.maxTexture,0),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,d),gl.bindTexture(gl.TEXTURE_2D,null);var e=gl.getAttribLocation(this.glProgram,"v_texCoord"),f=gl.getUniformLocation(this.glProgram,"raster"),g="band";WGL.getManager().storeUniformLoc(this.glProgram,g);var h=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,h),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1,1,-1,-1,1]),gl.STATIC_DRAW),this.setup=function(a){gl.useProgram(this.glProgram),gl.bindBuffer(gl.ARRAY_BUFFER,h),gl.enableVertexAttribArray(e),gl.vertexAttribPointer(e,2,gl.FLOAT,!1,0,0),gl.bindFramebuffer(gl.FRAMEBUFFER,c),gl.uniform1i(f,0),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,a),gl.viewport(0,0,c.width,c.height),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND)},this.render=function(a,b){this.setup(a),gl.uniform1f(this.glProgram[g],b),gl.drawArrays(gl.TRIANGLES,0,6),gl.bindTexture(gl.TEXTURE_2D,null),gl.useProgram(null)},this.getMax=function(a){return this.render(a),this.readPixels()},this.tearDown=function(){
gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.bindTexture(gl.TEXTURE_2D,null),gl.useProgram(null)},this.setMatrix=function(a){manager.matrices.push(a),manager.mapMatrix=a},this.readPixels=function(){gl.useProgram(this.glProgram),gl.bindFramebuffer(gl.FRAMEBUFFER,c);var d=new Uint8Array(a*b*4);gl.readPixels(0,0,a,b,gl.RGBA,gl.UNSIGNED_BYTE,d);var e=new Float32Array(d.buffer);return e}},WGL.internal.FloatReaderHistogram=function(a,b,c){var d=(WGL.getManager(),WGL.internal.GLUtils);this.raster=a,this.bin_count=b,this.height=c;var e=4*c;this.floatProgram=d.compileShaders("floathist_vShader","floathist_fShader",this);var f=gl.createFramebuffer();f.name="float frameBuffer";var g=gl.createRenderbuffer();this.floatTexture=gl.createTexture(),this.floatTexture.name="float texture",gl.bindFramebuffer(gl.FRAMEBUFFER,f),gl.bindTexture(gl.TEXTURE_2D,this.floatTexture),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,this.bin_count,e,0,gl.RGBA,gl.UNSIGNED_BYTE,null),gl.bindRenderbuffer(gl.RENDERBUFFER,g),gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,this.bin_count,e),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,this.floatTexture,0),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,g),this.buffer=gl.createBuffer(),this.buffer.name="ras_vert",gl.bindBuffer(gl.ARRAY_BUFFER,this.buffer),this.vertices=new Float32Array(2*this.bin_count*e);for(var h=0,i=0;e>i;i++)for(var j=0;j<this.bin_count;j++)this.vertices[h++]=j,this.vertices[h++]=i;this.buffer.itemSize=2,gl.bufferData(gl.ARRAY_BUFFER,this.vertices,gl.STATIC_DRAW),gl.bindRenderbuffer(gl.RENDERBUFFER,null),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.bindTexture(gl.TEXTURE_2D,null),gl.bindBuffer(gl.ARRAY_BUFFER,null),this.setup=function(){gl.useProgram(this.floatProgram),gl.bindFramebuffer(gl.FRAMEBUFFER,f),this.enableBuffer(this.buffer),gl.viewport(0,0,this.bin_count,e),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND)},this.enableBuffer=function(a){var b=a.name;gl.bindBuffer(gl.ARRAY_BUFFER,a),null==this.floatProgram[b]&&(this.floatProgram[b]=gl.getAttribLocation(this.floatProgram,b),gl.getAttribLocation(this.floatProgram,b)<0&&console.log("Error: attribute "+b+" does not exist.")),gl.enableVertexAttribArray(this.floatProgram[b]),gl.vertexAttribPointer(this.floatProgram[b],a.itemSize,gl.FLOAT,!1,0,0)},this.setUniforms=function(){},this.render=function(){null==this.floatProgram.rasterLoc&&(this.floatProgram.rasterLoc=gl.getUniformLocation(this.floatProgram,"floatRaster")),gl.uniform1i(this.floatProgram.rasterLoc,0),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,this.raster),this.bindIntUniform("height",e),this.bindIntUniform("width",this.bin_count),gl.drawArrays(gl.POINTS,0,this.bin_count*e),gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.bindTexture(gl.TEXTURE_2D,null)},this.bindIntUniform=function(a,b){return null==this.floatProgram[a]&&(this.floatProgram[a]=gl.getUniformLocation(this.floatProgram,a),!this.floatProgram[a]instanceof WebGLUniformLocation)?void console.error("Uniform set failed, uniform: "+a+" value "+value):void gl.uniform1f(this.floatProgram[a],b)},this.readPixels=function(){console.time("reading filter");var a=new Uint8Array(4*this.bin_count*e);gl.readPixels(0,0,this.bin_count,e,gl.RGBA,gl.UNSIGNED_BYTE,a);var b=new Float32Array(a.buffer);return gl.bindFramebuffer(gl.FRAMEBUFFER,null),b},this.readPixel=function(a,b){var c=new Uint8Array(4);gl.readPixels(a,b,1,1,gl.RGBA,gl.UNSIGNED_BYTE,c);var d=new Float32Array(c.buffer);return gl.bindFramebuffer(gl.FRAMEBUFFER,null),d}},create2DTexture=function(){var a=new Uint8Array(400);for(kk=0,o=0;o<10;o++)for(p=0;p<10;p++)a[kk++]=20*p,a[kk++]=25,a[kk++]=50,a[kk++]=255;var b=gl.createTexture();return gl.bindTexture(gl.TEXTURE_2D,b),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,10,1,0,gl.RGBA,gl.UNSIGNED_BYTE,a),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.bindTexture(gl.TEXTURE_2D,null),b},WGL.internal.GLUtils={loadShaders:function(a){var b;b=null==a?"http://localhost:9999/js/webglayer/":a,$.ajaxSetup({async:!1}),$.get(b+"shaders/shaders_linemap.glsl",function(a){$("head").append(a)}),$.get(b+"shaders/shaders_float.glsl",function(a){$("head").append(a)}),$.get(b+"shaders/shaders_filter_generic.glsl",function(a){$("head").append(a)}),$.get(b+"shaders/shaders_filterhist.glsl",function(a){$("head").append(a)}),$.get(b+"shaders/shaders_map_interpolation.glsl",function(a){$("head").append(a)}),$.get(b+"shaders/shaders_interpolation.glsl",function(a){$("head").append(a)}),$.get(b+"shaders/shaders_linechart.glsl",function(a){$("head").append(a)}),$.get(b+"shaders/shaders_sdlinechart.glsl",function(a){$("head").append(a)}),$.get(b+"shaders/shaders_map.glsl",function(a){$("head").append(a)}),$.get(b+"shaders/shaders_heatmap.glsl",function(a){$("head").append(a)}),$.get(b+"shaders/shaders_heatmap_render.glsl",function(a){$("head").append(a)}),$.get(b+"shaders/shaders_max_calculator.glsl",function(a){$("head").append(a)}),$.get(b+"shaders/shaders_floatreaderhistogram.glsl",function(a){$("head").append(a)}),$.get(b+"shaders/shaders_heat_hist.glsl",function(a){$("head").append(a)}),$.get(b+"shaders/shaders_linearhist.glsl",function(a){$("head").append(a)}),$.get(b+"shaders/shaders_linearhist_param.glsl",function(a){$("head").append(a)}),$.get(b+"shaders/shaders_filtermap.glsl",function(a){$("head").append(a)}),$.get(b+"shaders/shaders_filter_extent.glsl",function(a){$("head").append(a)}),$.get(b+"shaders/shaders_pc.glsl",function(a){$("head").append(a)}),$.get(b+"shaders/shaders_colorfiltermap.glsl",function(a){$("head").append(a)}),$.get(b+"shaders/shaders_pc_render.glsl",function(a){$("head").append(a)}),$.get(b+"shaders/shaders_fatline.glsl",function(a){$("head").append(a)}),$.ajaxSetup({async:!0})},compileShaders:function(a,b){var c=document.getElementById(a).text,d=gl.createShader(gl.VERTEX_SHADER);if(gl.shaderSource(d,c),gl.compileShader(d),!gl.getShaderParameter(d,gl.COMPILE_STATUS))return alert("An error occurred compiling the shaders: "+gl.getShaderInfoLog(d)),null;var e=document.getElementById(b).text,f=gl.createShader(gl.FRAGMENT_SHADER);if(gl.shaderSource(f,e),gl.compileShader(f),!gl.getShaderParameter(f,gl.COMPILE_STATUS))return alert("An error occurred compiling the shaders: "+gl.getShaderInfoLog(d)),null;var g=gl.createProgram();return gl.attachShader(g,d),gl.attachShader(g,f),gl.linkProgram(g),g}},WGL.internal.Manager=function(a){this.trasholds={allsum:0,spatsum:0};var b=null;this.setFilter=function(a){b=a},this.getFilter=function(){return b},this.updateMapSize=function(){this.mapdiv=document.getElementById(a);var b=document.getElementsByTagName("body")[0];document.getElementById(a).parentElement;this.b=b.offsetHeight-(this.mapdiv.offsetTop+this.mapdiv.offsetHeight),this.l=this.mapdiv.offsetLeft,this.w=this.mapdiv.offsetWidth,this.h=this.mapdiv.offsetHeight,this.body_width=b.offsetWidth,this.body_height=b.offsetHeight;var c=this.mapdiv.style.zIndex;c=""==c?1e3:parseInt(c)+1,this.canvas.setAttribute("id","webglayer"),this.canvas.setAttribute("width",this.body_width),this.canvas.setAttribute("height",this.body_height),this.canvas.setAttribute("style","position:absolute ; top:0px ; left:0px; pointer-events: none;opacity: 1;z-index: "+c)};this.mapdiv=document.getElementById(a);var c=document.getElementById(a).parentElement;this.canvas=document.createElement("canvas"),this.updateMapSize(),c.appendChild(this.canvas),gl=this.canvas.getContext("webgl",{preserveDrawingBuffer:!0})||this.canvas.getContext("experimental-webgl",{preserveDrawingBuffer:!0}),gl||alert("Could not initialise WebGL, sorry :-(. Are you using Chrome?"),this.databuffers=[],this.matrices=[],this.update=function(){gl=this.canvas.getContext("webgl",{preserveDrawingBuffer:!0,antialias:!0})||this.canvas.getContext("experimental-webgl",{preserveDrawingBuffer:!0}),gl||alert("Could not initialise WebGL, sorry :-(. Are you using Chrome?")},this.setMapMatrix=function(a){this.mapMatrix=a},this.rMatrix=new Float32Array(16),this.rMatrix.set([.5,0,0,0,0,.5,0,0,0,0,0,0,.5,.5,0,1]),this.rMatrix.name="rasterMatrix",this.matrices[this.rMatrix.name]=this.rMatrix,this.addDataBuffer=function(a,b,c,d,e){if("undefined"!=typeof this.databuffers[c])throw"buffer "+c+" already exists";var f=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,f),gl.bufferData(gl.ARRAY_BUFFER,a,gl.STATIC_DRAW),f.itemSize=b,f.numItems=a.length/b,f.name=c,f.min=d,f.max=e,gl.bindBuffer(gl.ARRAY_BUFFER,null),this.databuffers[c]=f},this.addElementBuffer=function(a,b,c){var d=gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,d),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,a,gl.STATIC_DRAW),d.itemSize=b,d.numItems=a.length/b,d.name=c,gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,null),this.databuffers[c]=d},this.enableBuffersAndCommonUniforms=function(a){for(var b in this.matrices){var c=this.matrices[b];null==a[c.name]&&(a[c.name]=this.getUniformLoc(a,c.name)),gl.uniformMatrix4fv(a[c.name],!1,c)}this.enableBufferForName(a,this.index,"index")},this.storeUniformLoc=function(a,b){if(null==a[b]){if(a[b]=gl.getUniformLocation(a,b),!a[b]instanceof WebGLUniformLocation)return void console.error("Uniform set failed, uniform: "+b+" value "+value)}else console.log("warning - uniform "+b+" already set.")},this.bindMapMatrix=function(a){null==a.matrixLoc&&(a.matrixLoc=this.getUniformLoc(a,this.mapMatrix.name)),gl.uniformMatrix4fv(a.matrixLoc,!1,this.mapMatrix)},this.bindRasterMatrix=function(a){null==a.rmatrixLoc&&(a.rmatrixLoc=this.getUniformLoc(a,this.rMatrix.name)),gl.uniformMatrix4fv(a.rmatrixLoc,!1,this.rMatrix)},this.enableBuffer=function(a,b){var c=this.databuffers[b];return gl.bindBuffer(gl.ARRAY_BUFFER,c),void 0==c?void console.error("Error: "+b+" is not registered in manager."):(null==a[b]&&(gl.getAttribLocation(a,c.name)>=0?a[b]=gl.getAttribLocation(a,c.name):console.log("Error: attribute "+c.name+" does not exist in program "+a.name)),gl.enableVertexAttribArray(a[b]),gl.vertexAttribPointer(a[b],c.itemSize,gl.FLOAT,!1,0,0),void gl.bindBuffer(gl.ARRAY_BUFFER,null))},this.bindElementBuffer=function(a){gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.databuffers[a])},this.enableBufferForName=function(a,b,c){var d=this.databuffers[b];if(gl.bindBuffer(gl.ARRAY_BUFFER,d),null==a[c]){if(!(gl.getAttribLocation(a,c)>=0))throw"Error: attribute "+c+" does not exist in program."+a.name;a[c]=gl.getAttribLocation(a,c)}if("undefined"==typeof d)throw"Buffer for "+c+" is not deffined.";gl.enableVertexAttribArray(a[c]),gl.vertexAttribPointer(a[c],d.itemSize,gl.FLOAT,!1,0,0)},this.enableFilterTexture=function(a){null==a.rasterLoc&&(a.rasterLoc=this.getUniformLoc(a,"filter")),gl.uniform1i(a.rasterLoc,0),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,b.getActiveTexture())},this.getUniformLoc=function(a,b){var c=gl.getUniformLocation(a,b);return null!=c?c:void console.error("Error setting common uniform "+b+" for program "+a.name)}},WGL.internal.MapController=function(){var a=WGL.getManager();this.layers=[],this.matrix,this.width,this.height,this.resize=function(){a.canvas.setAttribute("width",a.body_width),a.canvas.setAttribute("height",a.body_height),this.width=a.w,this.height=a.h,this.initMatrix(),this.updateMatrix(),WGL.updateSizeOfMapDimensions()},this.initMatrix=function(){this.matrix=new Float32Array([2/this.width,0,0,0,0,-2/this.height,0,0,0,0,0,0,-1,1,0,1]),this.matrix.name="mapMatrix",this.matrix.name="mapMatrix"},this.zoommove=function(b,c,d){function e(a,b,c){a[0]*=b,a[5]*=c}function f(a,b,c){a[12]+=a[0]*b,a[13]+=a[5]*c}a.zoom=b,this.initMatrix();var g=Math.pow(2,b);e(this.matrix,g,g),f(this.matrix,-c.x,-c.y),a.setMapMatrix(this.matrix),WGL.filterByExt()},this.updateMatrix=function(){a.width=this.width,a.height=this.height,a.setMapMatrix(this.matrix)}},WGL.internal.MaxCalculator=function(a,b){function c(a){for(var b=a.length,c=-(1/0);b--;){var d=a[b];d>c&&(c=d)}return c}this.glProgram=WGL.internal.GLUtils.compileShaders("max_calculator_vShader","max_calculator_fShader",this);var d=gl.createFramebuffer();d.width=a,d.height=b;var e=gl.createRenderbuffer();this.maxTexture=gl.createTexture(),this.maxTexture.name="max",this.floatReader=new WGL.internal.FloatRasterReader(d.width,d.height),gl.getExtension("OES_texture_float")||console.log("OES_texture_float not availble -- this is legal"),gl.bindFramebuffer(gl.FRAMEBUFFER,d),gl.bindTexture(gl.TEXTURE_2D,this.maxTexture),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,d.width,d.height,0,gl.RGBA,gl.FLOAT,null),gl.bindRenderbuffer(gl.RENDERBUFFER,e),gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,d.width,d.height),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,this.maxTexture,0),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,e),gl.bindTexture(gl.TEXTURE_2D,null);var f=gl.getAttribLocation(this.glProgram,"v_texCoord"),g=gl.getUniformLocation(this.glProgram,"heatmap_raster"),h=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,h),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1,1,-1,-1,1]),gl.STATIC_DRAW),this.setup=function(a){gl.useProgram(this.glProgram),gl.bindBuffer(gl.ARRAY_BUFFER,h),gl.enableVertexAttribArray(f),gl.vertexAttribPointer(f,2,gl.FLOAT,!1,0,0),gl.bindFramebuffer(gl.FRAMEBUFFER,d),gl.uniform1i(g,0),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,a),gl.viewport(0,0,d.width,d.height),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND)},this.render=function(a){this.setup(a),gl.drawArrays(gl.TRIANGLES,0,6),gl.bindTexture(gl.TEXTURE_2D,null),gl.useProgram(null)},this.getMax=function(a,b){this.render(a);var c=this.readPixels(b);return c},this.tearDown=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.bindTexture(gl.TEXTURE_2D,null),gl.useProgram(null)},this.setMatrix=function(a){manager.matrices.push(a),manager.mapMatrix=a},this.readPixels=function(a){this.floatReader.render(this.maxTexture,a);var b=this.floatReader.readPixels(),d=c(b);return d},this.getMaxExperiment=function(){this.render(),d.width=1,d.height=1,texture=this.maxTexture,this.maxTexture=gl.createTexture(),this.maxTexture.name="max",gl.bindFramebuffer(gl.FRAMEBUFFER,d),gl.bindTexture(gl.TEXTURE_2D,this.maxTexture),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,d.width,d.height,0,gl.RGBA,gl.FLOAT,null),gl.bindRenderbuffer(gl.RENDERBUFFER,e),gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,d.width,d.height),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,this.maxTexture,0),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,e),gl.bindTexture(gl.TEXTURE_2D,null),this.render(),this.readPixels(),gl.deleteTexture(texture)}},WGL.getDimension=function(a){return this._dimensions[a]},WGL.updateSizeOfMapDimensions=function(){var a=this._dimensions;for(var b in a){var c=a[b];if("undefined"!=typeof c.createMapFramebuffer&&c.createMapFramebuffer(),"undefined"!=typeof c.filters)for(var b in c.filters)"undefined"!=typeof c.filters[b].createMapFramebuffer&&c.filters[b].createMapFramebuffer()}},WGL.getNumberOfActiveFilters=function(){var a=this._dimensions,b=0;for(var c in a)for(var d in a[c].filters){var d=a[c].filters[d];d.isActive?(d.index=b,a[c].isSpatial&&(manager.spIndex=b),b++):a[c].isSpatial&&(manager.spIndex=-1)}return b},WGL.filterByExt=function(){var a=this._dimensions,b=this._mainFilter,c=!1;for(var d in a)if(a[d].isSpatial){for(var e in a[d].filters){var f=a[d].filters[e];f.isActive&&(f.updateFilter(),c=!0)}c&&(WGL.setFiltersTrasholds(),b.applyFilterAll(a),b.thisfilter=void 0)}"undefined"!=typeof extf&&extf.render(),this.render()},WGL.render=function(){var a=this._dimensions,b=this.getManager();gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.viewport(0,0,b.w,b.h),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);for(var c in a)a[c].render(b.num_rec);this.updateCharts()},WGL.filterDim=function(a,b,c,d){var e=this._dimensions,f=this._mainFilter,g=e[a].filters[b];return 0==c.length?(this.filterDeleted(a,b),void(f.thisfilter=void 0)):(c.length>0&&(b!=f.thisfilter||"undefined"==typeof f.thisfilter)&&(console.log("filter changed"),f.thisfilter=b,this.filterChanged(a,f.thisfilter)),g.createFilteringData(c),g.renderFilter(),f.applyFilterDim(e[a],b),void(void 0!=d&&1!=d||(this.render(),this.updateCharts())))},WGL.filterChanged=function(a,b){var c=this._dimensions,d=this._mainFilter;c[a].filters[b].isActive=!0,this.setFiltersTrasholds(),c[a].filters[b].isActive=!1,d.applyFilterAll(c),d.switchTextures(),c[a].filters[b].isActive=!0,"undefined"!=typeof extf&&extf.render()},WGL.filterDeleted=function(a,b){var c=this._dimensions,d=this._mainFilter;c[a].filters[b].isActive=!1,this.setFiltersTrasholds(),d.applyFilterAll(c),"undefined"!=typeof extf&&extf.render(),this.render(),this.updateCharts()},WGL.setFiltersTrasholds=function(){var a=this._dimensions,b=this.getManager(),c={allsum:0,spatsum:0},d=0;for(var e in a)for(var f in a[e].filters){var f=a[e].filters[f];f.isActive?(f.index=d,c.allsum=c.allsum+Math.pow(2,d),a[e].isSpatial&&(c.spatsum=c.spatsum+Math.pow(2,d),b.spIndex=d),d++):a[e].isSpatial&&(b.spIndex=-1)}this.getManager().trasholds=c},WGL.utils={normaliseByMax:function(a,b,c,d,e){var f=2/b*((d-c)/e),g=f*(a-c)-1;return g},array2TANormOrdinal:function(a){var b=new Float32Array(a.data.length),c=0;a.num_bins=a.domain.length,a.min=0,a.max=a.num_bins;for(var c in a.data){var d=a.domain.indexOf(a.data[c]);-1==d?(console.warn("data out of range "+a.data[c]),val=-1):val=(d+.5)/a.num_bins,b[c]=val}return b},array2TANormLinear:function(a,b){var c=new Float32Array(a.data.length),d=0;for(var d in a.data)isNaN(a.data[d])?val=0:val=(a.data[d]-a.min)/(a.max-a.min)*a.num_bins/b,c[d]=val;return c},array2TANorm:function(a,b){var c=new Float32Array(a.data.length),d=0;for(var d in a.data)isNaN(a.data[d])?val=0:val=(a.data[d]-a.min)/(a.max-a.min)*a.num_bins/b,c[d]=val;return c},array2TA2D:function(a){for(var b=new Float32Array(2*a.length),c=0,d=0,c=0;c<a.length;c++)b[d++]=a[c][0],b[d++]=a[c][1];return b},array2TA:function(a){for(var b=new Float32Array(a.length),c=0,c=0;c<a.length;c++)b[c]=a[c],a[c]=null;return b},array2TALines:function(a){this.getLength=function(a,b){return Math.sqrt(Math.pow(a.x-b.x,2)+Math.pow(a.y-b.y,2))},this.getAngleCos=function(a,b){var c=a.x*b.x+a.y*b.y,d=Math.sqrt(a.x*a.x+a.y*a.y)*Math.sqrt(b.x*b.x+b.y*b.y);return c/d};for(var b=new Float32Array(4*a.length*4),c=new Float32Array(4*a.length*4),d=[],e=0,f=0,g=0,h=0;h<a.length;h++){var i=a[h],j=[];g=g+i.length-1;for(var k=0;k<i.length;k++)if(0==k){var l=i[k],m=i[k+1],n=this.getLength(l,m);j[k]=[],j[k].y=-(l.x-m.x)/n,j[k].x=(l.y-m.y)/n}else if(k==i.length-1){var l=i[k-1],m=i[k],n=this.getLength(l,m);j[k]=[],j[k].y=-(l.x-m.x)/n,j[k].x=(l.y-m.y)/n}else{var l=i[k-1],m=i[k],o=i[k+1],p=this.getLength(l,m),q=this.getLength(m,o),r=(l.x-m.x)/p,s=(l.y-m.y)/p,t=(m.x-o.x)/q,u=(m.y-o.y)/q,v=r+t,w=s+u,x=this.getLength({x:0,y:0},{x:v,y:w}),y=this.getAngleCos({x:r,y:s},{x:v,y:w});j[k]=[],j[k].y=-(v/x)/y,j[k].x=w/x/y}for(var k=0;k<i.length;k++){var l=i[k],z=j[k];b[e++]=l.x,b[e++]=l.y,c[f++]=z.x,c[f++]=z.y,b[e++]=l.x,b[e++]=l.y,c[f++]=-z.x,c[f++]=-z.y;var A=e/2-2;k<i.length-1&&d.push(A,A+1,A+2,A+1,A+2,A+3)}}return{pts:b,norm:c,indicies:new Uint16Array(d),num:d.length}},Rasterer:function(a){this.size=Math.ceil(Math.sqrt(a)),this.calc=function(a){var c=Math.floor(a/this.size),d=a-this.size*c;return[b(d,this.size),b(c,this.size)]};var b=function(a,b){return a/b*2-1+2/(2*b)}}},WGL.ChartDiv=function(a,b,c){var d="<div class='btn-minimize'  id=min"+b+" style='margin: 0.5em'> <i id='but"+b+"' class='fa fa-chevron-down'></i><text> "+c+"</text></div> <div id = "+b+" class = 'vis-div' style='position: relative'></div> <hr/>";$("#"+a).append(d);var e;this.setDim=function(a){e=a},$("#min"+b).click(function(){$(this).toggleClass("btn-plus"),$("#"+b).slideToggle();var a=$("#but"+b);a.hasClass("fa-chevron-down")?(a.removeClass("fa-chevron-down"),a.addClass("fa-chevron-right"),void 0!=e&&e.setVisible(!1)):(a.removeClass("fa-chevron-right"),a.addClass("fa-chevron-down"),void 0!=e&&(e.setVisible(!0),WGL.render()))})},WGL.ui.HeatMapLegend=function(a,b){var c,d=(WGL.getManager(),WGL.internal.GLUtils,190),e=200,g={top:10,right:0,bottom:10,left:45},h=[],i=(d-g.left-g.right,e-g.top-g.bottom),j=d3.scale.linear().domain([0,200]).range([i,0]),k=d3.svg.axis().scale(j).orient("left"),l=d3.scale.linear().domain([0,200]).range([i,0]),m=d3.svg.axis().scale(l).orient("right"),n=!0;this.setDimension=function(a){c=a},this.drawWithoutFilter=function(){svg.select("#grad_b").attr("fill","url(#legend_gradient)")};var o=0;this.drawWithFilter=function(a){o=a,svg.select("#grad_b").attr("fill","url(#legend_blue_gradient)")},svg=d3.select("#"+a).append("svg").attr("width",d).attr("height",e).append("g").attr("transform","translate("+g.left+","+g.top+")"),svg.append("g").attr("class","y axis all").call(k).append("text").attr("transform","rotate(-90)").attr("y",-38).attr("dy",".71em").style("text-anchor","end").text("Magnitude-per-area within the radius "),svg.append("g").attr("class","y axis sel").call(m).attr("transform","translate(60,0)"),svg.append("defs").append("linearGradient").attr("id","legend_gradient").attr("x1","0%").attr("y1","0%").attr("x2","0%").attr("y2","100%").selectAll("stop").data([{offset:"0%",color:"rgba(255, 0, 0,1)"},{offset:"50%",color:"rgba(255, 255, 0,0.8)"},{offset:"100%",color:"rgba(0, 255, 0,0.6)"}]).enter().append("stop").attr("offset",function(a){return a.offset}).attr("stop-color",function(a){return a.color}),svg.append("defs").append("linearGradient").attr("id","legend_blue_gradient").attr("x1","0%").attr("y1","0%").attr("x2","0%").attr("y2","100%").selectAll("stop").data([{offset:"0%",color:"rgba(59, 130, 189,1)"},{offset:"50%",color:"rgba(158, 202,225,0.6)"},{offset:"100%",color:"rgba(222, 235,247,0.3)"}]).enter().append("stop").attr("offset",function(a){return a.offset}).attr("stop-color",function(a){return a.color}),svg.append("rect").attr("fill","black").attr("id","grad_bacground").attr("x",0).attr("y",0).attr("width",30).attr("height",i),svg.append("rect").attr("fill","url(#legend_blue_gradient)").attr("id","grad_b").attr("x",0).attr("y",0).attr("width",30).attr("height",i),svg.append("rect").attr("fill","black").attr("class","grad").attr("x",30).attr("y",0).attr("width",30).attr("height",0),svg.append("rect").attr("fill","url(#legend_gradient)").attr("class","grad").attr("x",30).attr("y",0).attr("width",30).attr("height",0);var p=function(){h=r.extent(),parseFloat(j.domain()[1])<=parseFloat(r.extent()[1])?(n=!1,console.log("setting to maximum.")):n=!0,q(r.extent())},q=function(a){svg.selectAll(".grad").attr("y",j(a[1])).attr("height",j(a[0])-j(a[1])),2==a.length&&a[0]==a[1]?(a=[],c.setFilter(void 0)):(h=a,c.setFilter(a)),WGL.filterDim(c.id,b,a)};this.reset=function(){r.clear(),p.call()};var r=d3.svg.brush().y(j).on("brush",p);svg.append("g").attr("class","brush").call(r).selectAll("rect").attr("width",60),this.updateMaxAll=function(a){var b=h;j.domain([0,a]),svg.selectAll(".y.axis.all").call(k),b[0]!=b[1]?this.update(b):this.update([0,0])},this.showSelection=function(){svg.selectAll(".grad").attr("y",0).attr("height",j(f[0])-j(f[1]))},this.update=function(a){h=a;var b=h[0],c=h[1],d=j(c),e=j(b)-j(c);svg.selectAll(".grad").attr("y",d).attr("height",e),svg.selectAll(".extent").attr("y",d).attr("height",e),svg.selectAll(".y.axis.sel").attr("transform","translate(60,"+d+")"),l.domain([0,o]).range([e,0]),m.ticks(e/15),svg.selectAll(".y.axis.sel").call(m)}},WGL.ui.StackedBarChart=function(a,b,c,d,e){function f(){p=d3.scale.linear().domain([0,n.max[w]]).range([y,0]),s=d3.svg.axis().scale(p).orient("left"),u.selectAll(".y.axis").transition().duration(30).call(s),u.selectAll(".selected.bar").attr("d",g),u.selectAll(".unselected.bar").attr("d",h),u.selectAll(".out.bar").attr("d",i)}function g(a){for(var b,c=[],d=-1,e=a.length;++d<e;){var b=a[d];c.push("M",o(b.val),",",y,"V",p(b.selected),z,y)}return c.join("")}function h(a){for(var b,c=[],d=-1,e=a.length;++d<e;){var b=a[d];c.push("M",o(b.val),",",p(b.selected),"V",p(b.selected)+p(b.unselected)-y,z,p(b.selected))}return c.join("")}function i(a){for(var b,c=[],d=-1,e=a.length;++d<e;){var b=a[d],f=p(b.selected)+p(b.unselected)-y;c.push("M",o(b.val),",",f,"V",f+p(b.out)-y,z,f)}return c.join("")}var j,b,k,l,m;"undefined"==typeof e?(k=500,l=215,m={top:20,right:20,bottom:65,left:60}):(k=e.w,l=e.h,m=e.margin);var n,o,p,q,r,s,t,u,v,w=2,x=k-m.left-m.right,y=l-m.top-m.bottom,n=null,z="";this.setLinearXScale=function(){o=new d3.scale.linear,o=d3.scale.linear().domain([a.min,a.max]).range([0,x]);var b=Math.floor(x/n.length);return z="h"+b+"V",j="linear",this},this.setOrdinalXScale=function(){o=d3.scale.ordinal().domain(a.domain).rangeBands([0,x],.03,.015);var b=o.rangeBand();return z="h"+b+"V",j="ordinal",this},this.xformat=function(a){return a},this.init=function(){function e(){var b=B.extent();WGL.filterDim(a.name,d,b)}function g(){var b=B.extent(),c=[],e=o.domain().length;for(var f in b)c[f]=[],c[f][0]=b[f][0]/x*e,c[f][1]=b[f][1]/x*e;WGL.filterDim(a.name,d,c)}function h(a){a.attr("height",y)}"undefined"==typeof a.domain?this.setLinearXScale():this.setOrdinalXScale();var i=["#ff8c00","#7b6888","#98abc5"],z=[["0","selected",i[0]],["1","unselected",i[1]],["2","out",i[2]]];q=d3.scale.ordinal().range(i),p=d3.scale.linear().domain([0,n.max[2]]).range([y,0]),q.domain(["selected","unselected","out"]),r=d3.svg.axis().scale(o).orient("bottom").tickFormat(this.xformat),s=d3.svg.axis().scale(p).orient("left"),u=d3.select("#"+b).append("svg").attr("width",x+m.left+m.right).attr("height",y+m.top+m.bottom).append("g").attr("transform","translate("+m.left+","+m.top+")"),v=u.select(".chart"),u.append("g").attr("class","x axis").attr("transform","translate(0,"+y+")").call(r).append("text").attr("y","3.5em").attr("x",x/2).style("text-anchor","end").text(c),u.append("g").attr("class","y axis").call(s).append("text").attr("transform","rotate(270)").attr("y","-4.5em").attr("x","-2em").style("text-anchor","end").text("number of items"),u.append("clipPath").attr("id","clip-"+b).append("rect").attr("width",x).attr("height",y),t=u.selectAll(".bar").data(["selected","unselected","out"]).enter().append("path").attr("class",function(a){return a+" foreground bar "}).datum(n),u.selectAll(".foreground.bar").attr("clip-path","url(#clip-"+b+")"),n.forEach(function(a){var b=0;a.levels=q.domain().map(function(c){return{name:c,y0:b,y1:b+=+a[c]}}),a.total=0});var A;"linear"==j?A=e:"ordinal"==j&&(A=g);var B=d3.svg.multibrush().x(o).extentAdaption(h).on("brush",A).on("brushend",function(a){0==B.extent().length&&A()});this.brush=B;var C=(u.append("g").attr("class","brush").call(B).selectAll("rect").attr("height",y),u.append("g").attr("class","l").selectAll("rect").data(z));C.enter().append("rect").attr("id",function(a){return b+a[0]}).attr("x",k-150).attr("y",function(a){return l-63+15*a[0]}).attr("width",12).attr("height",12).attr("fill",function(a){return a[2]}).on("click",function(a){d3.select("#"+b+a[0]);w=a[0];for(var c=0;c<z.length;c++)f()}),C.enter().append("text").text(function(a){return a[1]}).attr("x",k-130).attr("y",function(a){return l-63+15*a[0]+12}).attr("width",12).attr("height",12).attr("stroke","none")},this.update=function(a){null==n&&(n=Array.prototype.slice.call(a),n.max=a.max,this.init()),n=Array.prototype.slice.call(a),n.max=a.max,t.datum(n),f()}},d3.svg.multibrush=function(){function a(a){var b=a[0],c=a[a.length-1];return c>b?[b,c]:[c,b]}function b(b){return b.rangeExtent?b.rangeExtent():a(b.range())}function c(){var a=".dragsuppress-"+ ++l,b="click"+a,c=d3.select(window).on("touchmove"+a,d3.event.preventDefault()).on("dragstart"+a,d3.event.preventDefault()).on("selectstart"+a,d3.event.preventDefault());if(k){var d=d3_documentElement.style,e=d[k];d[k]="none"}return function(f){function g(){c.on(b,null)}c.on(a,null),k&&(d[k]=e),f&&(c.on(b,function(){d3.event.preventDefault(),g()},!0),setTimeout(g,0))}}function d(a){a.each(function(){var a=d3.select(this).style("pointer-events","all").style("-webkit-tap-highlight-color","rgba(0,0,0,0)").on("mousedown.brush",i).on("touchstart.brush",i);j=a;var c=a.selectAll(".background").data([0]);c.enter().append("rect").attr("class","background").style("visibility","hidden").style("cursor","crosshair"),e(a);var d,k=d3.transition(a),l=d3.transition(c);n&&(d=b(n),l.attr("x",d[0]).attr("width",d[1]-d[0]),g(k)),o&&(d=b(o),l.attr("y",d[0]).attr("height",d[1]-d[0]),h(k)),f(k)})}function e(a){var b=p.length>q.length?p:q;b.length;extentArr=b.map(function(a,b){return b}),extentResizes=d3.merge(b.map(function(a,b){return v.map(function(a){return[a,b]})})),a||(a=j);var c=a.selectAll(".extent").data(extentArr,function(a){return a});c.exit().remove(),c.enter().append("rect").attr("class","extent").style("cursor","move").call(x);var e=a.selectAll(".resize").data(extentResizes,function(a){return a[0]+a[1]});e.exit().remove();var f=e.enter().append("g").attr("class",function(a){return"resize "+a[0]}).style("cursor",function(a){return d3_svg_brushCursor[a[0]]});f.append("rect").attr("x",function(a){return/[ew]$/.test(a[0])?-3:null}).attr("y",function(a){return/^[ns]/.test(a[0])?-3:null}).attr("width",6).attr("height",6).style("visibility","hidden"),f.call(w),e.style("display",function(a){return d.empty(a[1])?"none":null})}function f(a){a.selectAll(".resize").attr("transform",function(a){return"translate("+p[a[1]][+/e$/.test(a[0])]+","+q[a[1]][+/^s/.test(a[0])]+")"})}function g(a){a.selectAll(".extent").attr("x",function(a){return p[a][0]}),a.selectAll(".extent,.n>rect,.s>rect").attr("width",function(a){return p[a][1]-p[a][0]})}function h(a){a.selectAll(".extent").attr("y",function(a){return q[a][0]}),a.selectAll(".extent,.e>rect,.w>rect").attr("height",function(a){return q[a][1]-q[a][0]})}function i(){function a(){32==d3.event.keyCode&&(F||(v=null,H[0]-=p[x][1],H[1]-=q[x][1],F=2),d3.event.preventDefault())}function i(){32==d3.event.keyCode&&2==F&&(H[0]+=p[x][1],H[1]+=q[x][1],F=0,d3.event.preventDefault())}function j(){var a=d3.mouse(y),b=!1;w&&(a[0]+=w[0],a[1]+=w[1]),F||(d3.event.altKey?(v||(v=[(p[x][0]+p[x][1])/2,(q[x][0]+q[x][1])/2]),H[0]=p[x][+(a[0]<v[0])],H[1]=q[x][+(a[1]<v[1])]):v=null),D&&k(a,n,0)&&(g(B,x),b=!0),E&&k(a,o,1)&&(h(B,x),b=!0),b&&(f(B),A({type:"brush",mode:F?"move":"resize"}))}function k(a,c,d){var e,f,g=b(c),h=g[0],i=g[1],j=H[d],k=d?q[x]:p[x],l=k[1]-k[0];return F&&(h-=j,i-=l+j),e=(d?u:t)?Math.max(h,Math.min(i,a[d])):a[d],F?f=(e+=j)+l:(v&&(j=Math.max(h,Math.min(i,2*v[d]-e))),e>j?(f=e,e=j):f=j),k[0]!=e||k[1]!=f?(d?s[x]=null:r[x]=null,k[0]=e,k[1]=f,!0):void 0}function l(){j(),(n&&p[x][0]==p[x][1]||o&&q[x][0]==q[x][1])&&d.clear(),B.style("pointer-events","all").selectAll(".resize").style("display",function(a){return d.empty(a[1])?"none":null}),d3.select("body").style("cursor",null),I.on("mousemove.brush",null).on("mouseup.brush",null).on("touchmove.brush",null).on("touchend.brush",null).on("keydown.brush",null).on("keyup.brush",null),
e(),G(),A({type:"brushend"})}var v,w,x,y=this,z=d3.select(d3.event.target),A=m.of(y,arguments),B=d3.select(y),C=z.datum()[0],D=!/^(n|s)$/.test(C)&&n,E=!/^(e|w)$/.test(C)&&o,F=z.classed("extent"),G=c(),H=d3.mouse(y),I=d3.select(window).on("keydown.brush",a).on("keyup.brush",i);if(d3.event.changedTouches?I.on("touchmove.brush",j).on("touchend.brush",l):I.on("mousemove.brush",j).on("mouseup.brush",l),F)x=z.datum(),H[0]=p[x][0]-H[0],H[1]=q[x][0]-H[1];else if(C){var J=+/w$/.test(C),K=+/^n/.test(C);x=z.datum()[1],w=[p[x][1-J]-H[0],q[x][1-K]-H[1]],H[0]=p[x][J],H[1]=q[x][K]}else x=p.length-1,p.push([0,0]),q.push([0,0]),d3.event.altKey&&(v=H.slice());B.style("pointer-events","none"),d3.select("body").style("cursor",z.style("cursor")),F||C||B.selectAll(".resize").style("display",null),A({type:"brushstart"}),j()}var j,k=null,l=0,m=d3.dispatch("brushstart","brush","brushend"),n=null,o=null,p=[[0,0]],q=[[0,0]],r=[],s=[],t=!0,u=!0,v=d3_svg_brushResizes[0],w=function(){},x=function(){};return m.of=function(a,b){return function(c){try{var e=c.sourceEvent=d3.event;c.target=d,d3.event=c,m[c.type].apply(a,b)}finally{d3.event=e}}},d.event=function(a){a.each(function(){var a=m.of(this,arguments),b={x:p,y:q,i:r,j:s},c=this.__chart__||b;this.__chart__=b,d3_transitionInheritId?d3.select(this).transition().each("start.brush",function(){r=c.i,s=c.j,p=c.x,q=c.y,a({type:"brushstart"})}).tween("brush:brush",function(){var c=d3_interpolateArray(p[0],b.x[0]),d=d3_interpolateArray(q[0],b.y[0]);return r[0]=s[0]=null,function(e){p[0]=b.x[0]=c(e),q[0]=b.y[0]=d(e),a({type:"brush",mode:"resize"})}}).each("end.brush",function(){r=b.i,s=b.j,a({type:"brush",mode:"resize"}),a({type:"brushend"})}):(a({type:"brushstart"}),a({type:"brush",mode:"resize"}),a({type:"brushend"}))})},d.x=function(a){return arguments.length?(n=a,v=d3_svg_brushResizes[!n<<1|!o],d):n},d.y=function(a){return arguments.length?(o=a,v=d3_svg_brushResizes[!n<<1|!o],d):o},d.resizeAdaption=function(a){return arguments.length?(w=a,d):w},d.extentAdaption=function(a){return arguments.length?(x=a,d):x},d.clamp=function(a){return arguments.length?(n&&o?(t=!!a[0],u=!!a[1]):n?t=!!a:o&&(u=!!a),d):n&&o?[t,u]:n?t:o?u:null},d.extent=function(a){var b,c,e=[];return arguments.length?(n&&(b=a,o&&(b=b.map(function(a){return[a[0][0],a[1][0]]})),r=b,b=b.map(function(a){return n.invert?[n(a[0]),n(a[1])]:a}).map(function(a){return a[1]<a[0]?[a[1],a[0]]:a}),p=b,o||(q=b.map(function(){return[0,0]}))),o&&(c=a,n&&(c=c.map(function(a){return[a[0][1],a[1][1]]})),s=c,c=c.map(function(a){return o.invert?[o(a[0]),o(a[1])]:a}).map(function(a){return a[1]<a[0]?[a[1],a[0]]:a}),q=c,n||(p=c.map(function(){return[0,0]}))),0===p.length&&(p=[[0,0]]),0===q.length&&(q=[[0,0]]),d):(n&&(b=r[0]?r:p.map(function(a){return n.invert?[n.invert(a[0]),n.invert(a[1])]:a}).map(function(a){return a[1]<a[0]?[a[1],a[0]]:a}).filter(function(a){return a[1]-a[0]!=0})),o&&(c=s[0]?s:q.map(function(a){return o.invert?[o.invert(a[0]),o.invert(a[1])]:a}).map(function(a){return a[1]<a[0]?[a[1],a[0]]:a}).filter(function(a){return a[1]-a[0]!=0})),n&&o&&b.forEach(function(a,b){e.push([[a[0],c[b][0]],[a[1],c[b][1]]])}),n&&o?e:n?b:o&&c)},d.clear=function(){return p=[[0,0]],q=[[0,0]],r=s=[],e(),n&&g(j),o&&h(j),d},d.empty=function(a){return 1==p.length&&1==q.length&&(a=0),void 0!==a?!!n&&p[a][0]==p[a][1]||!!o&&q[a][0]==q[a][1]:!1},d3.rebind(d,m,"on")};var d3_svg_brushCursor={n:"ns-resize",e:"ew-resize",s:"ns-resize",w:"ew-resize",nw:"nwse-resize",ne:"nesw-resize",se:"nwse-resize",sw:"nesw-resize"},d3_svg_brushResizes=[["n","e","s","w","nw","ne","se","sw"],["e","w"],["n","s"],[]];